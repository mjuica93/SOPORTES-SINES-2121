<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Integrado de Soportes e Isom√©tricos SINES</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.98);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c5f2d 0%, #97bc62 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: rotate 20s linear infinite;
        }

        @keyframes rotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            position: relative;
            z-index: 1;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
            overflow-x: auto;
        }

        .tab {
            flex: 1;
            min-width: 200px;
            padding: 20px;
            text-align: center;
            background: #e9ecef;
            border: none;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #495057;
            white-space: nowrap;
        }

        .tab.active {
            background: #fff;
            color: #2c5f2d;
            border-bottom: 3px solid #2c5f2d;
        }

        .tab:hover {
            background: #fff;
            transform: translateY(-2px);
        }

        .tab-content {
            display: none;
            padding: 30px;
        }

        .tab-content.active {
            display: block;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card h3 {
            font-size: 2.5em;
            margin-bottom: 5px;
        }

        .stat-card p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .filters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 15px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .filter-group label {
            font-weight: 600;
            color: #495057;
            font-size: 1.1em;
        }

        .filter-group input, .filter-group select {
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }

        .filter-group input:focus, .filter-group select:focus {
            outline: none;
            border-color: #2c5f2d;
        }

        .search-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-bottom: 30px;
        }

        .search-btn {
            background: linear-gradient(135deg, #2c5f2d 0%, #97bc62 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .search-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        .search-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .clear-btn {
            background: #dc3545;
        }

        .export-btn {
            background: #28a745;
        }

        .installation-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin: 30px 0;
            flex-wrap: wrap;
        }

        .pagination-btn {
            background: #2c5f2d;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s ease;
        }

        .pagination-btn:hover:not(:disabled) {
            background: #1a3a1b;
            transform: translateY(-2px);
        }

        .pagination-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .pagination-info {
            background: #f8f9fa;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            color: #495057;
        }

        .results {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            min-height: 400px;
        }

        .result-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            border-left: 5px solid #2c5f2d;
        }

        .result-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        }

        .result-card h3 {
            color: #2c5f2d;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .result-card .info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .result-card .info div {
            padding: 8px 12px;
            background: #f8f9fa;
            border-radius: 8px;
            font-size: 0.9em;
        }

        .result-card .info div strong {
            color: #2c5f2d;
        }

        .installation-status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-left: 10px;
        }

        .status-pending {
            background: #ffc107;
            color: #856404;
        }

        .status-planned {
            background: #17a2b8;
            color: #0c5460;
        }

        .status-in_progress {
            background: #fd7e14;
            color: #974406;
        }

        .status-installed {
            background: #28a745;
            color: #155724;
        }

        .overdue-indicator {
            background: #dc3545;
            color: white;
            padding: 3px 8px;
            border-radius: 8px;
            font-size: 0.75em;
            font-weight: 600;
            margin-left: 5px;
        }

        /* Estilos espec√≠ficos para soldadura */
        .welding-progress-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        .welding-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #dc3545 0%, #ffc107 50%, #28a745 100%);
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 0.8em;
        }

        .diameter-breakdown {
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .diameter-breakdown h4 {
            color: #2c5f2d;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .diameter-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #dee2e6;
        }

        .diameter-item:last-child {
            border-bottom: none;
        }

        .diameter-info {
            display: flex;
            flex-direction: column;
        }

        .diameter-size {
            font-weight: 600;
            color: #2c5f2d;
        }

        .diameter-details {
            font-size: 0.9em;
            color: #6c757d;
        }

        .welding-status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-0 {
            background: #dc3545;
            color: white;
        }

        .status-low {
            background: #fd7e14;
            color: white;
        }

        .status-medium {
            background: #ffc107;
            color: #856404;
        }

        .status-high {
            background: #17a2b8;
            color: white;
        }

        .status-complete {
            background: #28a745;
            color: white;
        }
        
        .type-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: bold;
            margin-left: 10px;
        }
        
        .type-badge.regular {
            background-color: #2196F3;
            color: white;
        }
        
        .type-badge.prefabricated {
            background-color: #FF9800;
            color: white;
        }

        .installation-section {
            margin-top: 15px;
            padding: 15px;
            background: #e3f2fd;
            border-radius: 10px;
            border-left: 4px solid #2196f3;
        }

        .installation-section h4 {
            color: #1976d2;
            margin-bottom: 10px;
        }

        .installation-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 10px;
        }

        .installation-controls {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .install-btn {
            background: #17a2b8;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
        }

        .install-btn:hover {
            background: #138496;
            transform: translateY(-1px);
        }

        .isometric-section {
            margin-top: 15px;
            padding: 15px;
            background: #e8f5e8;
            border-radius: 10px;
        }

        .isometric-section h4 {
            color: #2c5f2d;
            margin-bottom: 10px;
        }

        .isometric-files {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
        }

        .isometric-file {
            background: #2c5f2d;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            text-decoration: none;
            font-size: 0.9em;
            transition: background-color 0.3s ease;
        }

        .isometric-file:hover {
            background: #1a3a1b;
        }
        
        .more-files {
            color: #666;
            font-style: italic;
            padding: 8px 12px;
            background: #f5f5f5;
            border-radius: 6px;
        }

        .prefab-file {
            background: #ff6b35 !important;
            border: 2px solid #ff4500 !important;
        }

        /* Estilos para la tabla de costuras */
        .table-responsive {
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .table-striped tbody tr:nth-of-type(odd) {
            background-color: rgba(0,0,0,0.02);
        }

        .table-hover tbody tr:hover {
            background-color: rgba(0,123,255,0.1);
        }

        .status-select {
            min-width: 150px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 0.875rem;
        }

        .status-select:focus {
            border-color: #80bdff;
            box-shadow: 0 0 0 0.2rem rgba(0,123,255,0.25);
        }

        /* Estilos para filas modificadas */
        tr.modified {
            background-color: #fff3cd !important;
            border-left: 4px solid #ffc107;
        }

        tr.saved {
            background-color: #d4edda !important;
            border-left: 4px solid #28a745;
            animation: saved-flash 2s ease-in-out;
        }

        @keyframes saved-flash {
            0% { background-color: #d4edda; }
            50% { background-color: #c3e6cb; }
            100% { background-color: #d4edda; }
        }

        /* Estilos para comentarios */
        .form-control-sm {
            font-size: 0.875rem;
            padding: 0.25rem 0.5rem;
        }

        /* Estilos para botones de acci√≥n */
        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
            border-radius: 0.2rem;
        }

        /* Estilos para el modal de gesti√≥n */
        .modal-xl {
            max-width: 1200px;
        }

        .modal-body {
            padding: 1.5rem;
        }

        .modal-header {
            border-bottom: 1px solid #dee2e6;
        }

        .modal-footer {
            border-top: 1px solid #dee2e6;
        }

        /* Estilos para interacci√≥n mejorada */
        .clickable-row {
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .clickable-row:hover {
            background-color: rgba(0,123,255,0.1) !important;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .selected-row {
            background-color: rgba(40,167,69,0.15) !important;
            border-left: 4px solid #28a745;
        }

        .row-number {
            font-weight: bold;
            color: #495057;
        }

        .isometric-info strong {
            color: #2c5f2d;
            font-size: 0.95em;
        }

        .isometric-info small {
            font-size: 0.8em;
        }

        .diameter-badge {
            background-color: #17a2b8;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-weight: bold;
            font-size: 0.85em;
        }

        .progress-container {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .progress-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75em;
            font-weight: bold;
            color: white;
            position: relative;
        }

        .progress-circle[data-progress="0"] { background-color: #dc3545; }
        .progress-circle[data-progress*="1"], .progress-circle[data-progress*="2"] { background-color: #fd7e14; }
        .progress-circle[data-progress*="3"], .progress-circle[data-progress*="4"], .progress-circle[data-progress*="5"] { background-color: #ffc107; color: #000; }
        .progress-circle[data-progress*="6"], .progress-circle[data-progress*="7"], .progress-circle[data-progress*="8"] { background-color: #17a2b8; }
        .progress-circle[data-progress*="9"], .progress-circle[data-progress="100"] { background-color: #28a745; }

        .comment-input {
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 0.85em;
        }

        .comment-input:focus {
            border-color: #80bdff;
            box-shadow: 0 0 0 0.2rem rgba(0,123,255,0.25);
        }

        .action-buttons-container {
            display: flex;
            gap: 4px;
            justify-content: center;
        }

        .action-btn {
            padding: 0.2rem 0.4rem;
            font-size: 0.8rem;
            border-radius: 3px;
            transition: all 0.2s ease;
        }

        .action-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .selection-counter {
            border-radius: 8px;
            border: 1px solid #bee5eb;
            background-color: #d1ecf1;
            color: #0c5460;
            font-weight: 500;
        }

        /* Animaciones */
        @keyframes row-select {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }

        .selected-row {
            animation: row-select 0.3s ease;
        }

        /* Responsive para dispositivos m√≥viles */
        @media (max-width: 768px) {
            .modal-xl {
                max-width: 95%;
                margin: 10px auto;
            }
            
            .table-responsive {
                font-size: 0.85em;
            }
            
            .action-buttons-container {
                flex-direction: column;
                gap: 2px;
            }
            
            .progress-circle {
                width: 30px;
                height: 30px;
                font-size: 0.7em;
            }
            
            .diameter-badge {
                font-size: 0.75em;
                padding: 2px 6px;
            }
        }

        /* Estilos para el estado de carga */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255,255,255,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007bff;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Estilos para estad√≠sticas en tiempo real */
        .live-stats {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            border: 1px solid #dee2e6;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 10px;
        }

        .stat-item {
            text-align: center;
            padding: 8px;
            border-radius: 6px;
            border: 1px solid #dee2e6;
            background-color: white;
            transition: all 0.3s ease;
        }

        .stat-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .stat-number {
            display: block;
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 2px;
        }

        .stat-label {
            display: block;
            font-size: 0.75em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-pending {
            border-left: 4px solid #ffc107;
        }

        .stat-pending .stat-number {
            color: #ffc107;
        }

        .stat-progress {
            border-left: 4px solid #17a2b8;
        }

        .stat-progress .stat-number {
            color: #17a2b8;
        }

        .stat-completed {
            border-left: 4px solid #28a745;
        }

        .stat-completed .stat-number {
            color: #28a745;
        }

        .stat-inspection {
            border-left: 4px solid #fd7e14;
        }

        .stat-inspection .stat-number {
            color: #fd7e14;
        }

        .overall-progress {
            background-color: white;
            border-radius: 6px;
            padding: 10px;
            border: 1px solid #dee2e6;
        }

        .progress-label {
            font-size: 0.9em;
            margin-bottom: 5px;
        }

        .progress-percentage {
            color: #28a745;
            font-size: 1.1em;
        }

        /* Responsive para estad√≠sticas */
        @media (max-width: 576px) {
            .stats-grid {
                grid-template-columns: repeat(4, 1fr);
                gap: 5px;
            }
            
            .stat-item {
                padding: 6px;
            }
            
            .stat-number {
                font-size: 1.2em;
            }
            
            .stat-label {
                font-size: 0.65em;
            }
        }

        .prefab-file:hover {
            background: #e55a2b !important;
        }
        
        .welding-actions {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e9ecef;
        }
        
        .welding-actions h4 {
            font-size: 14px;
            margin-bottom: 10px;
            color: #495057;
        }
        
        .action-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }
        
        .weld-item {
            background-color: #f8f9fa;
            transition: all 0.2s ease;
        }
        
        .weld-item:hover {
            background-color: #e9ecef;
            transform: translateY(-1px);
        }
        
        .modal-dialog {
            max-width: 600px;
        }
        
        .modal-lg {
            max-width: 800px;
        }
        
        .form-check-label {
            cursor: pointer;
            width: 100%;
            padding: 8px;
            border-radius: 5px;
            transition: background-color 0.2s ease;
        }
        
        .form-check-label:hover {
            background-color: #f8f9fa;
        }
        
        .form-check-input:checked + .form-check-label {
            background-color: #e3f2fd;
        }

        .prefab-indicator {
            background: #ff6b35;
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: bold;
            margin-left: 5px;
        }

        .loading {
            text-align: center;
            padding: 50px;
            font-size: 1.2em;
            color: #666;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .no-results {
            text-align: center;
            padding: 50px;
            color: #666;
            font-size: 1.2em;
            grid-column: 1 / -1;
        }

        .initial-message {
            text-align: center;
            padding: 60px 20px;
            background: #f8f9fa;
            border-radius: 15px;
            margin: 20px 0;
        }

        .initial-message h3 {
            color: #2c5f2d;
            margin-bottom: 15px;
            font-size: 1.5em;
        }

        .initial-message p {
            color: #666;
            font-size: 1.1em;
            line-height: 1.6;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            color: #2c5f2d;
            font-size: 1.5em;
            font-weight: 600;
        }

        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .close:hover {
            color: #000;
        }

        .modal-body {
            margin-bottom: 20px;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
        }

        .modal-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .modal-btn-primary {
            background: #2c5f2d;
            color: white;
        }

        .modal-btn-primary:hover {
            background: #1a3a1b;
            transform: translateY(-2px);
        }

        .modal-btn-secondary {
            background: #6c757d;
            color: white;
        }

        .modal-btn-secondary:hover {
            background: #545b62;
            transform: translateY(-2px);
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2em;
            }
            
            .filters {
                grid-template-columns: 1fr;
            }
            
            .results {
                grid-template-columns: 1fr;
            }
            
            .result-card .info {
                grid-template-columns: 1fr;
            }
            
            .pagination {
                flex-direction: column;
                gap: 10px;
            }
            
            .search-actions, .installation-actions {
                flex-direction: column;
                align-items: center;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .tab {
                min-width: unset;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Sistema Integrado SINES - Versi√≥n Mejorada</h1>
            <p>Gesti√≥n Completa: Soportes Agrupados con Variables de Plantilla, Isom√©tricos, Relaciones, Soldadura e Instalaciones - Versi√≥n 5.0</p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('soportes')">üìã Soportes Mejorados</button>
            <button class="tab" onclick="switchTab('isometricos')">üìê Isom√©tricos</button>
            <button class="tab" onclick="switchTab('relaciones')">üîó Relaciones</button>
            <button class="tab" onclick="switchTab('soldadura')">‚ö° Soldadura</button>
            <button class="tab" onclick="switchTab('instalaciones')">üîß Instalaciones</button>
        </div>

        <!-- TAB SOPORTES -->
        <div id="soportes" class="tab-content active">
            <div class="stats">
                <div class="stat-card">
                    <h3 id="totalSupports">0</h3>
                    <p>Total Soportes</p>
                </div>
                <div class="stat-card">
                    <h3 id="totalTypes">0</h3>
                    <p>Tipos Diferentes</p>
                </div>
                <div class="stat-card">
                    <h3 id="withPDFs">0</h3>
                    <p>Con PDFs</p>
                </div>
                <div class="stat-card">
                    <h3 id="searchResults">0</h3>
                    <p>Resultados</p>
                </div>
            </div>

            <div class="filters">
                <div class="filter-group">
                    <label for="supportSearch">üîç Buscar Soporte:</label>
                    <input type="text" id="supportSearch" placeholder="Buscar por n√∫mero o tipo de soporte...">
                </div>
                <div class="filter-group">
                    <label for="typeFilter">üìÇ Filtrar por Tipo:</label>
                    <select id="typeFilter">
                        <option value="">Todos los tipos</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="lineFilter">üîß Filtrar por L√≠nea:</label>
                    <select id="lineFilter">
                        <option value="">Todas las l√≠neas</option>
                    </select>
                </div>
            </div>

            <div class="search-actions">
                <button class="search-btn" onclick="performSearch('soportes')">üîç Buscar Soportes</button>
                <button class="search-btn clear-btn" onclick="clearSearch('soportes')">üóëÔ∏è Limpiar</button>
                <button class="search-btn" id="toggleGroupBtn" onclick="toggleGroupView()">üìä Vista Agrupada</button>
            </div>

            <div class="pagination" id="supportPagination" style="display: none;">
                <button class="pagination-btn" onclick="changePage('soportes', 'prev')">‚¨ÖÔ∏è Anterior</button>
                <div class="pagination-info" id="supportPageInfo"></div>
                <button class="pagination-btn" onclick="changePage('soportes', 'next')">Siguiente ‚û°Ô∏è</button>
            </div>

            <div id="supportResults" class="results"></div>
        </div>

        <!-- TAB ISOM√âTRICOS -->
        <div id="isometricos" class="tab-content">
            <div class="stats">
                <div class="stat-card">
                    <h3 id="totalLines">0</h3>
                    <p>Total L√≠neas</p>
                </div>
                <div class="stat-card">
                    <h3 id="totalSheets">0</h3>
                    <p>Total Hojas</p>
                </div>
                <div class="stat-card">
                    <h3 id="totalIsometricFiles">0</h3>
                    <p>Archivos PDF</p>
                </div>
                <div class="stat-card">
                    <h3 id="totalPrefabricatedFiles">0</h3>
                    <p>Prefabricados</p>
                </div>
                <div class="stat-card">
                    <h3 id="isometricSearchResults">0</h3>
                    <p>Resultados</p>
                </div>
            </div>

            <div class="filters">
                <div class="filter-group">
                    <label for="isometricSearch">üîç Buscar Isom√©trico:</label>
                    <input type="text" id="isometricSearch" placeholder="Buscar por l√≠nea, fluido o archivo...">
                </div>
                <div class="filter-group">
                    <label for="fluidFilter">üåä Filtrar por Fluido:</label>
                    <select id="fluidFilter">
                        <option value="">Todos los fluidos</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="typeIsometricFilter">üìã Filtrar por Tipo:</label>
                    <select id="typeIsometricFilter">
                        <option value="">Todos los tipos</option>
                        <option value="LB">LB</option>
                        <option value="SB">SB</option>
                    </select>
                </div>
                </div>

            <div class="search-actions">
                <button class="search-btn" onclick="performSearch('isometricos')">üîç Buscar Isom√©tricos</button>
                <button class="search-btn clear-btn" onclick="clearSearch('isometricos')">üóëÔ∏è Limpiar</button>
            </div>

            <div class="pagination" id="isometricPagination" style="display: none;">
                <button class="pagination-btn" onclick="changePage('isometricos', 'prev')">‚¨ÖÔ∏è Anterior</button>
                <div class="pagination-info" id="isometricPageInfo"></div>
                <button class="pagination-btn" onclick="changePage('isometricos', 'next')">Siguiente ‚û°Ô∏è</button>
            </div>

            <div id="isometricResults" class="results"></div>
        </div>

        <!-- TAB RELACIONES -->
        <div id="relaciones" class="tab-content">
            <div class="stats">
                <div class="stat-card">
                    <h3 id="totalRelations">0</h3>
                    <p>Total Relaciones</p>
                    </div>
                <div class="stat-card">
                    <h3 id="linesWithSupports">0</h3>
                    <p>L√≠neas con Soportes</p>
                    </div>
                <div class="stat-card">
                    <h3 id="supportsWithIsometrics">0</h3>
                    <p>Soportes con Isom√©tricos</p>
                </div>
                <div class="stat-card">
                    <h3 id="relationSearchResults">0</h3>
                    <p>Resultados</p>
                </div>
            </div>

            <div class="filters">
                <div class="filter-group">
                    <label for="relationSearch">üîç Buscar Relaci√≥n:</label>
                    <input type="text" id="relationSearch" placeholder="Buscar por soporte, l√≠nea o fluido...">
                </div>
                <div class="filter-group">
                    <label for="supportTypeFilter">‚öôÔ∏è Filtrar por Tipo de Soporte:</label>
                    <select id="supportTypeFilter">
                        <option value="">Todos los tipos</option>
                        </select>
                    </div>
                <div class="filter-group">
                    <label for="relationFluidFilter">üåä Filtrar por Fluido:</label>
                    <select id="relationFluidFilter">
                        <option value="">Todos los fluidos</option>
                    </select>
                    </div>
                </div>

            <div class="search-actions">
                <button class="search-btn" onclick="performSearch('relaciones')">üîç Buscar Relaciones</button>
                <button class="search-btn clear-btn" onclick="clearSearch('relaciones')">üóëÔ∏è Limpiar</button>
            </div>

            <div class="pagination" id="relationPagination" style="display: none;">
                <button class="pagination-btn" onclick="changePage('relaciones', 'prev')">‚¨ÖÔ∏è Anterior</button>
                <div class="pagination-info" id="relationPageInfo"></div>
                <button class="pagination-btn" onclick="changePage('relaciones', 'next')">Siguiente ‚û°Ô∏è</button>
            </div>

            <div id="relationResults" class="results"></div>
        </div>

        <!-- TAB SOLDADURA -->
        <div id="soldadura" class="tab-content">
            <div class="stats">
                <div class="stat-card">
                    <h3 id="totalWeldingIsometrics">0</h3>
                    <p>Isom√©tricos con Costuras</p>
                </div>
                <div class="stat-card">
                    <h3 id="totalWelds">0</h3>
                    <p>Total Costuras</p>
                </div>
                <div class="stat-card">
                    <h3 id="completedWelds">0</h3>
                    <p>Costuras Completadas</p>
                </div>
                <div class="stat-card">
                    <h3 id="pendingWelds">0</h3>
                    <p>Costuras Pendientes</p>
                </div>
                <div class="stat-card">
                    <h3 id="weldingProgress">0%</h3>
                    <p>Progreso General</p>
                </div>
                <div class="stat-card">
                    <h3 id="weldingSearchResults">0</h3>
                    <p>Resultados</p>
                </div>
            </div>

            <div class="filters">
                <div class="filter-group">
                    <label for="weldingSearch">üîç Buscar Isom√©trico:</label>
                    <input type="text" id="weldingSearch" placeholder="Buscar por nombre de isom√©trico...">
                </div>
                <div class="filter-group">
                    <label for="weldingStatusFilter">üìä Filtrar por Estado:</label>
                    <select id="weldingStatusFilter">
                        <option value="">Todos los estados</option>
                        <option value="0">Sin comenzar (0%)</option>
                        <option value="1-25">En inicio (1-25%)</option>
                        <option value="26-50">En progreso (26-50%)</option>
                        <option value="51-75">Avanzado (51-75%)</option>
                        <option value="76-99">Casi completo (76-99%)</option>
                        <option value="100">Completado (100%)</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="diameterFilter">üìè Filtrar por Di√°metro:</label>
                    <select id="diameterFilter">
                        <option value="">Todos los di√°metros</option>
                    </select>
                </div>
            </div>

            <div class="search-actions">
                <button class="search-btn" onclick="performSearch('soldadura')">üîç Buscar Costuras</button>
                <button class="search-btn clear-btn" onclick="clearSearch('soldadura')">üóëÔ∏è Limpiar</button>
                <button class="search-btn export-btn" onclick="exportWeldingData()">üìä Exportar Datos</button>
            </div>

            <div class="pagination" id="weldingPagination" style="display: none;">
                <button class="pagination-btn" onclick="changePage('soldadura', 'prev')">‚¨ÖÔ∏è Anterior</button>
                <div class="pagination-info" id="weldingPageInfo"></div>
                <button class="pagination-btn" onclick="changePage('soldadura', 'next')">Siguiente ‚û°Ô∏è</button>
            </div>

            <div id="weldingResults" class="results"></div>
        </div>

        <!-- TAB INSTALACIONES -->
        <div id="instalaciones" class="tab-content">
            <div class="stats">
                <div class="stat-card">
                    <h3 id="totalInstallations">0</h3>
                    <p>Total Instalaciones</p>
                </div>
                <div class="stat-card">
                    <h3 id="pendingInstallations">0</h3>
                    <p>Pendientes</p>
                </div>
                <div class="stat-card">
                    <h3 id="completedInstallations">0</h3>
                    <p>Completadas</p>
                </div>
                <div class="stat-card">
                    <h3 id="installationSearchResults">0</h3>
                    <p>Resultados</p>
                </div>
            </div>

            <div class="filters">
                <div class="filter-group">
                    <label for="installationSearch">üîç Buscar Instalaci√≥n:</label>
                    <input type="text" id="installationSearch" placeholder="Buscar por soporte, tipo o responsable...">
                </div>
                <div class="filter-group">
                    <label for="statusFilter">üìä Filtrar por Estado:</label>
                    <select id="statusFilter">
                        <option value="">Todos los estados</option>
                        <option value="pending">Pendiente</option>
                        <option value="planned">Planificado</option>
                        <option value="in_progress">En Progreso</option>
                        <option value="installed">Instalado</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="dateFilter">üìÖ Filtrar por Fecha:</label>
                    <input type="date" id="dateFilter">
            </div>
        </div>

            <div class="installation-actions">
                <button class="search-btn" onclick="performSearch('instalaciones')">üîç Buscar Instalaciones</button>
                <button class="search-btn clear-btn" onclick="clearSearch('instalaciones')">üóëÔ∏è Limpiar</button>
                <button class="search-btn export-btn" onclick="exportInstallations()">üìä Exportar</button>
                    </div>

            <div class="pagination" id="installationPagination" style="display: none;">
                <button class="pagination-btn" onclick="changePage('instalaciones', 'prev')">‚¨ÖÔ∏è Anterior</button>
                <div class="pagination-info" id="installationPageInfo"></div>
                <button class="pagination-btn" onclick="changePage('instalaciones', 'next')">Siguiente ‚û°Ô∏è</button>
                    </div>

            <div id="installationResults" class="results"></div>
        </div>
    </div>

    <!-- Modal para Edici√≥n de Instalaci√≥n -->
    <div id="editInstallationModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Editar Instalaci√≥n</h3>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="filter-group">
                    <label for="modalSupportInfo">Informaci√≥n del Soporte:</label>
                    <input type="text" id="modalSupportInfo" readonly>
                </div>
                <div class="filter-group">
                    <label for="modalInstallationStatus">Estado:</label>
                    <select id="modalInstallationStatus" onchange="toggleDateFields()">
                        <option value="pending">Pendiente</option>
                        <option value="planned">Planificado</option>
                        <option value="in_progress">En Progreso</option>
                        <option value="installed">Instalado</option>
                        </select>
                    </div>
                <div class="filter-group">
                    <label for="modalPlannedDate">Fecha Planificada:</label>
                    <input type="date" id="modalPlannedDate">
                    </div>
                <div class="filter-group">
                    <label for="modalActualDate">Fecha Real:</label>
                    <input type="date" id="modalActualDate">
                    </div>
                <div class="filter-group">
                    <label for="modalInstalledBy">Instalado Por:</label>
                    <input type="text" id="modalInstalledBy" placeholder="Nombre del responsable">
                    </div>
                <div class="filter-group">
                    <label for="modalInstallationNotes">Notas:</label>
                    <textarea id="modalInstallationNotes" rows="3" placeholder="Notas adicionales sobre la instalaci√≥n" style="width: 100%; padding: 12px; border: 2px solid #dee2e6; border-radius: 10px; resize: vertical;"></textarea>
                    </div>
                    </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-secondary" onclick="closeModal()">Cancelar</button>
                <button class="modal-btn modal-btn-primary" onclick="saveInstallation()">Guardar</button>
                </div>
                </div>
            </div>

    <div id="loading" class="loading" style="display: none;">
        <p>‚è≥ Cargando datos...</p>
            </div>

    <script src="installation_manager.js"></script>
    <script src="welding_status_manager.js"></script>
    <script>
        // Variables globales
        let allSupports = [];
        let supportMapping = {};
        let isometricData = {};
        let supportIsometricRelations = [];
        let prefabricatedMapping = {};
        let filteredSupports = [];
        let filteredIsometrics = [];
        let filteredRelations = [];
        let filteredInstallations = [];
        let filteredWelding = [];
        let currentTab = 'soportes';
        
        // Variables para el sistema mejorado
        let templateVariables = {};
        let supportDimensions = {};
        let groupedSupports = {};
        let showGrouped = false;
        
        // Variables para soldadura
        let weldingData = {};
        let weldingStatistics = {};

        // Configuraci√≥n de paginaci√≥n
        const ITEMS_PER_PAGE = 12;
        let currentPage = {
            soportes: 1,
            isometricos: 1,
            relaciones: 1,
            soldadura: 1,
            instalaciones: 1
        };

        // Estados de b√∫squeda
        let searchPerformed = {
            soportes: false,
            isometricos: false,
            relaciones: false,
            soldadura: false,
            instalaciones: false
        };

        // Variable para el soporte en edici√≥n
        let currentEditingSupport = null;

        // Cargar datos al iniciar
        document.addEventListener('DOMContentLoaded', function() {
            loadAllData();
            setupEventListeners();
        });

        // Configurar event listeners
        function setupEventListeners() {
            // Listeners para Enter en los campos de b√∫squeda
            document.getElementById('supportSearch').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') performSearch('soportes');
            });
            document.getElementById('isometricSearch').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') performSearch('isometricos');
            });
            document.getElementById('relationSearch').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') performSearch('relaciones');
            });
            document.getElementById('weldingSearch').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') performSearch('soldadura');
            });
            document.getElementById('installationSearch').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') performSearch('instalaciones');
            });

            // Listener para cerrar modal con Escape
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') closeModal();
            });

            // Listener para cerrar modal haciendo clic fuera
            window.addEventListener('click', function(e) {
                const modal = document.getElementById('editInstallationModal');
                if (e.target === modal) closeModal();
            });
        }

        // Funci√≥n para mostrar notificaciones
        function showNotification(message, type = 'info') {
            // Crear elemento de notificaci√≥n
            const notification = document.createElement('div');
            notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            notification.style.cssText = `
                top: 20px;
                right: 20px;
                z-index: 9999;
                min-width: 300px;
                max-width: 400px;
                box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            `;
            
            const typeIcons = {
                'success': '‚úÖ',
                'error': '‚ùå',
                'warning': '‚ö†Ô∏è',
                'info': '‚ÑπÔ∏è'
            };
            
            notification.innerHTML = `
                <div class="d-flex align-items-center">
                    <span class="me-2">${typeIcons[type] || '‚ÑπÔ∏è'}</span>
                    <span>${message}</span>
                    <button type="button" class="btn-close ms-auto" onclick="this.parentElement.parentElement.remove()"></button>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Auto-remover despu√©s de 5 segundos
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 5000);
        }

        // Cargar todos los datos
        async function loadAllData() {
            try {
                showLoading(true);
                
                // Cargar datos de soportes
                const supportsResponse = await fetch('support_data_enhanced.json');
                allSupports = await supportsResponse.json();
                
                // Cargar mapeo de PDFs de soportes
                const mappingResponse = await fetch('support_pdf_mapping.json');
                supportMapping = await mappingResponse.json();
                
                // Cargar datos de isom√©tricos
                const isometricResponse = await fetch('isometric_data_with_prefabricated.json');
                isometricData = await isometricResponse.json();
                
                // Cargar relaciones soportes-isom√©tricos
                const relationResponse = await fetch('support_isometric_relation.json');
                supportIsometricRelations = await relationResponse.json();
                
                // Cargar mapeo de isom√©tricos prefabricados
                try {
                    const prefabResponse = await fetch('prefabricated_isometric_mapping_github.json');
                    const prefabData = await prefabResponse.json();
                    prefabricatedMapping = prefabData.correspondences || {};
                    console.log(`üìã Cargadas ${Object.keys(prefabricatedMapping).length} correspondencias de isom√©tricos prefabricados`);
                } catch (error) {
                    console.warn('No se encontr√≥ mapeo de isom√©tricos prefabricados:', error);
                    prefabricatedMapping = {};
                }
                
                // Cargar datos de variables de plantilla
                try {
                    const templateResponse = await fetch('template_variables_mapping.json');
                    templateVariables = await templateResponse.json();
                    console.log(`üìê Cargadas ${Object.keys(templateVariables).length} variables de plantilla`);
                } catch (error) {
                    console.warn('No se encontr√≥ mapeo de variables de plantilla:', error);
                    templateVariables = {};
                }
                
                // Cargar datos de dimensiones de soportes
                try {
                    const dimensionsResponse = await fetch('support_dimensions_data.json');
                    const dimensionsArray = await dimensionsResponse.json();
                    
                    // Convertir array a objeto indexado por support_number y support_type
                    supportDimensions = {};
                    dimensionsArray.forEach(item => {
                        const key = `${item.support_number}-${item.support_type}`;
                        supportDimensions[key] = item.dimensions;
                    });
                    
                    console.log(`üìè Cargadas dimensiones para ${dimensionsArray.length} registros de soportes`);
                } catch (error) {
                    console.warn('No se encontraron datos de dimensiones:', error);
                    supportDimensions = {};
                }
                
                // Cargar datos de soldadura con relaciones
                try {
                    const weldingEnhancedResponse = await fetch('welding_enhanced_data.json');
                    const weldingEnhancedData = await weldingEnhancedResponse.json();
                    
                    weldingData = weldingEnhancedData.relations || [];
                    weldingStatistics = weldingEnhancedData.statistics || {};
                    
                    console.log(`‚ö° Cargados ${weldingData.length} relaciones de soldadura`);
                    console.log(`üìä Cargadas estad√≠sticas de ${Object.keys(weldingStatistics).length} l√≠neas`);
                    console.log(`üîó Total costuras: ${weldingEnhancedData.summary?.total_welds || 0}`);
                } catch (error) {
                    console.warn('No se encontraron datos de soldadura:', error);
                    weldingData = [];
                    weldingStatistics = {};
                }
                
                // Inicializar el sistema de gesti√≥n de soldadura
                try {
                    if (window.weldingStatusManager) {
                        await window.weldingStatusManager.initialize();
                        console.log('‚úÖ Sistema de gesti√≥n de soldadura inicializado');
                    }
                } catch (error) {
                    console.warn('Error inicializando gestor de soldadura:', error);
                }
                
                // Inicializar el gestor de instalaciones
                window.installationManager = new InstallationManager();
                
                // Inicializar la aplicaci√≥n
                initializeApp();
                
            } catch (error) {
                console.error('Error cargando datos:', error);
                showError('Error al cargar los datos. Verifica que los archivos JSON est√©n disponibles.');
            } finally {
                showLoading(false);
            }
        }

        // Inicializar la aplicaci√≥n
        function initializeApp() {
            populateFilters();
            updateStats();
            showInitialMessage();
        }

        // Mostrar mensaje inicial
        function showInitialMessage() {
            const containers = ['supportResults', 'isometricResults', 'relationResults', 'weldingResults', 'installationResults'];
            const messages = [
                'üìã Utiliza los filtros y haz clic en "Buscar Soportes" para ver los resultados',
                'üìê Utiliza los filtros y haz clic en "Buscar Isom√©tricos" para ver los resultados',
                'üîó Utiliza los filtros y haz clic en "Buscar Relaciones" para ver los resultados',
                '‚ö° Utiliza los filtros y haz clic en "Buscar Costuras" para ver los resultados',
                'üîß Utiliza los filtros y haz clic en "Buscar Instalaciones" para ver los resultados'
            ];

            containers.forEach((containerId, index) => {
                const container = document.getElementById(containerId);
                container.innerHTML = `
                    <div class="initial-message">
                        <h3>¬°Bienvenido al Sistema SINES Integrado!</h3>
                        <p>${messages[index]}</p>
                        <p>üöÄ Rendimiento optimizado: Mostramos ${ITEMS_PER_PAGE} resultados por p√°gina</p>
                        <p>üìä Trazabilidad completa: Soportes ‚Üî Isom√©tricos ‚Üî Instalaciones</p>
        </div>
                `;
            });
        }

        // Poblar filtros
        function populateFilters() {
            // Filtros de soportes
            const supportTypes = [...new Set(allSupports.map(s => s.support_type))].sort();
            const supportLines = [...new Set(allSupports.map(s => s.fluid_piping).filter(l => l))].sort();
            
            populateSelect('typeFilter', supportTypes);
            populateSelect('lineFilter', supportLines);
            
            // Filtros de isom√©tricos
            const fluids = [...new Set(Object.values(isometricData).map(i => i.fluid).filter(f => f))].sort();
            populateSelect('fluidFilter', fluids);
            
            // Filtros de relaciones
            populateSelect('supportTypeFilter', supportTypes);
            populateSelect('relationFluidFilter', fluids);
            
            // Filtros de soldadura
            const diameters = new Set();
            Object.values(weldingStatistics).forEach(lineStats => {
                Object.keys(lineStats.diameter_breakdown || {}).forEach(diameter => {
                    if (diameter && diameter !== '0') {
                        diameters.add(parseFloat(diameter));
                    }
                });
            });
            const sortedDiameters = [...diameters].sort((a, b) => a - b);
            populateSelect('diameterFilter', sortedDiameters.map(d => `${d}"`));
        }

        // Poblar select
        function populateSelect(selectId, options) {
            const select = document.getElementById(selectId);
            const firstOption = select.firstElementChild;
            select.innerHTML = '';
            select.appendChild(firstOption);
            
            options.forEach(option => {
                const optionElement = document.createElement('option');
                optionElement.value = option;
                optionElement.textContent = option;
                select.appendChild(optionElement);
            });
        }

        // Actualizar estad√≠sticas
        function updateStats() {
            // Estad√≠sticas de soportes
            const totalSupports = allSupports.length;
            const totalTypes = new Set(allSupports.map(s => s.support_type)).size;
            const withPDFs = allSupports.filter(s => supportMapping[s.support_type] && supportMapping[s.support_type].length > 0).length;
            
            document.getElementById('totalSupports').textContent = totalSupports.toLocaleString();
            document.getElementById('totalTypes').textContent = totalTypes.toLocaleString();
            document.getElementById('withPDFs').textContent = withPDFs.toLocaleString();
            
            // Estad√≠sticas de isom√©tricos
            const totalLines = Object.keys(isometricData).length;
            const totalSheets = Object.values(isometricData).reduce((acc, line) => acc + line.sheets.length, 0);
            const totalIsometricFiles = totalSheets;
            
            // Contar isom√©tricos prefabricados
            const totalPrefabricatedFiles = Object.keys(prefabricatedMapping).length;
            
            document.getElementById('totalLines').textContent = totalLines.toLocaleString();
            document.getElementById('totalSheets').textContent = totalSheets.toLocaleString();
            document.getElementById('totalIsometricFiles').textContent = totalIsometricFiles.toLocaleString();
            document.getElementById('totalPrefabricatedFiles').textContent = totalPrefabricatedFiles.toLocaleString();
            
            // Estad√≠sticas de relaciones
            const totalRelations = supportIsometricRelations.length;
            const linesWithSupports = new Set(supportIsometricRelations.map(r => r.line_code)).size;
            const supportsWithIsometrics = new Set(supportIsometricRelations.map(r => r.support_number)).size;
            
            document.getElementById('totalRelations').textContent = totalRelations.toLocaleString();
            document.getElementById('linesWithSupports').textContent = linesWithSupports.toLocaleString();
            document.getElementById('supportsWithIsometrics').textContent = supportsWithIsometrics.toLocaleString();
            
            // Estad√≠sticas de soldadura
            const totalWeldingIsometrics = Object.keys(weldingStatistics).length;
            
            // Calcular estad√≠sticas desde las relaciones
            let totalWelds = 0;
            let completedWelds = 0;
            
            Object.values(weldingStatistics).forEach(lineStats => {
                totalWelds += lineStats.total_welds || 0;
                completedWelds += lineStats.completed_welds || 0;
            });
            
            const pendingWelds = totalWelds - completedWelds;
            const overallProgress = totalWelds > 0 ? Math.round((completedWelds / totalWelds) * 100) : 0;
            
            document.getElementById('totalWeldingIsometrics').textContent = totalWeldingIsometrics.toLocaleString();
            document.getElementById('totalWelds').textContent = totalWelds.toLocaleString();
            document.getElementById('completedWelds').textContent = completedWelds.toLocaleString();
            document.getElementById('pendingWelds').textContent = pendingWelds.toLocaleString();
            document.getElementById('weldingProgress').textContent = `${overallProgress}%`;
            
            // Estad√≠sticas de instalaciones
            if (window.installationManager) {
                const installationStats = window.installationManager.getStats();
                document.getElementById('totalInstallations').textContent = allSupports.length.toLocaleString();
                document.getElementById('pendingInstallations').textContent = installationStats.pending.toLocaleString();
                document.getElementById('completedInstallations').textContent = installationStats.installed.toLocaleString();
            }
        }

        // Cambiar tab
        function switchTab(tabName) {
            // Actualizar botones
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add('active');
            
            // Actualizar contenido
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            
            currentTab = tabName;
            
            // Mostrar mensaje inicial si no se ha realizado b√∫squeda
            if (!searchPerformed[tabName]) {
                showInitialMessage();
            }
        }

        // Realizar b√∫squeda
        function performSearch(tabType) {
            currentPage[tabType] = 1; // Resetear a la primera p√°gina
            searchPerformed[tabType] = true;
            
            switch(tabType) {
                case 'soportes':
                    filterSupports();
                    break;
                case 'isometricos':
                    filterIsometrics();
                    break;
                case 'relaciones':
                    filterRelations();
                    break;
                case 'soldadura':
                    filterWelding();
                    break;
                case 'instalaciones':
                    filterInstallations();
                    break;
            }
        }

        // Limpiar b√∫squeda
        function clearSearch(tabType) {
            // Limpiar filtros
            switch(tabType) {
                case 'soportes':
                    document.getElementById('supportSearch').value = '';
                    document.getElementById('typeFilter').value = '';
                    document.getElementById('lineFilter').value = '';
                    break;
                case 'isometricos':
                    document.getElementById('isometricSearch').value = '';
                    document.getElementById('fluidFilter').value = '';
                    document.getElementById('typeIsometricFilter').value = '';
                    break;
                case 'relaciones':
                    document.getElementById('relationSearch').value = '';
                    document.getElementById('supportTypeFilter').value = '';
                    document.getElementById('relationFluidFilter').value = '';
                    break;
                case 'soldadura':
                    document.getElementById('weldingSearch').value = '';
                    document.getElementById('weldingStatusFilter').value = '';
                    document.getElementById('diameterFilter').value = '';
                    break;
                case 'instalaciones':
                    document.getElementById('installationSearch').value = '';
                    document.getElementById('statusFilter').value = '';
                    document.getElementById('dateFilter').value = '';
                    break;
            }
            
            // Ocultar paginaci√≥n y mostrar mensaje inicial
            document.getElementById(`${tabType.slice(0, -1)}Pagination`).style.display = 'none';
            if (tabType === 'soportes') document.getElementById('supportPagination').style.display = 'none';
            
            searchPerformed[tabType] = false;
            currentPage[tabType] = 1;
            
            // Actualizar resultados
            updateSearchResults(tabType, 0);
            showInitialMessage();
        }

        // Cambiar p√°gina
        function changePage(tabType, direction) {
            const totalResults = getTotalResults(tabType);
            const totalPages = Math.ceil(totalResults / ITEMS_PER_PAGE);
            
            if (direction === 'prev' && currentPage[tabType] > 1) {
                currentPage[tabType]--;
            } else if (direction === 'next' && currentPage[tabType] < totalPages) {
                currentPage[tabType]++;
            }
            
            displayResults(tabType);
            updatePagination(tabType);
        }

        // Obtener total de resultados
        function getTotalResults(tabType) {
            switch(tabType) {
                case 'soportes':
                    return filteredSupports.length;
                case 'isometricos':
                    return filteredIsometrics.length;
                case 'relaciones':
                    return filteredRelations.length;
                case 'soldadura':
                    return filteredWelding.length;
                case 'instalaciones':
                    return filteredInstallations.length;
                default:
                    return 0;
            }
        }

        // Filtrar soportes
        function filterSupports() {
            const searchTerm = document.getElementById('supportSearch').value.toLowerCase();
            const typeFilter = document.getElementById('typeFilter').value;
            const lineFilter = document.getElementById('lineFilter').value;
            
            filteredSupports = allSupports.filter(support => {
                const matchesSearch = !searchTerm || 
                    support.support_number.toLowerCase().includes(searchTerm) ||
                    support.support_type.toLowerCase().includes(searchTerm) ||
                    support.fluid_piping.toLowerCase().includes(searchTerm);
                
                const matchesType = !typeFilter || support.support_type === typeFilter;
                const matchesLine = !lineFilter || support.fluid_piping === lineFilter;
                
                return matchesSearch && matchesType && matchesLine;
            });
            
            updateSearchResults('soportes', filteredSupports.length);
            displayResults('soportes');
            updatePagination('soportes');
        }

        // Filtrar isom√©tricos
        function filterIsometrics() {
            const searchTerm = document.getElementById('isometricSearch').value.toLowerCase();
            const fluidFilter = document.getElementById('fluidFilter').value;
            const typeFilter = document.getElementById('typeIsometricFilter').value;
            
            filteredIsometrics = Object.values(isometricData).filter(line => {
                const matchesSearch = !searchTerm || 
                    line.line_code.toLowerCase().includes(searchTerm) ||
                    line.fluid.toLowerCase().includes(searchTerm) ||
                    line.sheets.some(sheet => sheet.filename.toLowerCase().includes(searchTerm));
                
                const matchesFluid = !fluidFilter || line.fluid === fluidFilter;
                const matchesType = !typeFilter || line.sheets.some(sheet => sheet.type === typeFilter);
                
                return matchesSearch && matchesFluid && matchesType;
            });
            
            updateSearchResults('isometricos', filteredIsometrics.length);
            displayResults('isometricos');
            updatePagination('isometricos');
        }

        // Filtrar relaciones
        function filterRelations() {
            const searchTerm = document.getElementById('relationSearch').value.toLowerCase();
            const supportTypeFilter = document.getElementById('supportTypeFilter').value;
            const fluidFilter = document.getElementById('relationFluidFilter').value;
            
            filteredRelations = supportIsometricRelations.filter(relation => {
                const matchesSearch = !searchTerm || 
                    relation.support_number.toLowerCase().includes(searchTerm) ||
                    relation.support_type.toLowerCase().includes(searchTerm) ||
                    relation.line_code.toLowerCase().includes(searchTerm) ||
                    relation.fluid.toLowerCase().includes(searchTerm);
                
                const matchesType = !supportTypeFilter || relation.support_type === supportTypeFilter;
                const matchesFluid = !fluidFilter || relation.fluid === fluidFilter;
                
                return matchesSearch && matchesType && matchesFluid;
            });
            
            updateSearchResults('relaciones', filteredRelations.length);
            displayResults('relaciones');
            updatePagination('relaciones');
        }

        // Filtrar soldadura
        function filterWelding() {
            const searchTerm = document.getElementById('weldingSearch').value.toLowerCase();
            const statusFilter = document.getElementById('weldingStatusFilter').value;
            const diameterFilter = document.getElementById('diameterFilter').value;
            
            // Filtrar l√≠neas bas√°ndose en estad√≠sticas
            filteredWelding = Object.entries(weldingStatistics).filter(([line, stats]) => {
                const matchesSearch = !searchTerm || line.toLowerCase().includes(searchTerm);
                
                let matchesStatus = true;
                if (statusFilter) {
                    const progress = stats.progress_percentage || 0;
                    
                    switch(statusFilter) {
                        case '0':
                            matchesStatus = progress === 0;
                            break;
                        case '1-25':
                            matchesStatus = progress >= 1 && progress <= 25;
                            break;
                        case '26-50':
                            matchesStatus = progress >= 26 && progress <= 50;
                            break;
                        case '51-75':
                            matchesStatus = progress >= 51 && progress <= 75;
                            break;
                        case '76-99':
                            matchesStatus = progress >= 76 && progress <= 99;
                            break;
                        case '100':
                            matchesStatus = progress === 100;
                            break;
                    }
                }
                
                let matchesDiameter = true;
                if (diameterFilter) {
                    const diameter = parseFloat(diameterFilter.replace('"', ''));
                    const diameterBreakdown = stats.diameter_breakdown || {};
                    matchesDiameter = Object.keys(diameterBreakdown).some(d => parseFloat(d) === diameter);
                }
                
                return matchesSearch && matchesStatus && matchesDiameter;
            });
            
            updateSearchResults('soldadura', filteredWelding.length);
            displayResults('soldadura');
            updatePagination('soldadura');
        }

        // Filtrar instalaciones
        function filterInstallations() {
            const searchTerm = document.getElementById('installationSearch').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            const dateFilter = document.getElementById('dateFilter').value;
            
            filteredInstallations = window.installationManager.filterInstallations(searchTerm, statusFilter, dateFilter);
            
            updateSearchResults('instalaciones', filteredInstallations.length);
            displayResults('instalaciones');
            updatePagination('instalaciones');
        }

        // Actualizar contador de resultados
        function updateSearchResults(tabType, count) {
            const elementId = tabType === 'soportes' ? 'searchResults' : 
                             tabType === 'isometricos' ? 'isometricSearchResults' :
                             tabType === 'relaciones' ? 'relationSearchResults' :
                             tabType === 'soldadura' ? 'weldingSearchResults' : 'installationSearchResults';
            document.getElementById(elementId).textContent = count.toLocaleString();
        }

        // Mostrar resultados paginados
        function displayResults(tabType) {
            const page = currentPage[tabType];
            const startIndex = (page - 1) * ITEMS_PER_PAGE;
            const endIndex = startIndex + ITEMS_PER_PAGE;
            
            switch(tabType) {
                case 'soportes':
                    displaySupports(startIndex, endIndex);
                    break;
                case 'isometricos':
                    displayIsometrics(startIndex, endIndex);
                    break;
                case 'relaciones':
                    displayRelations(startIndex, endIndex);
                    break;
                case 'soldadura':
                    displayWelding(startIndex, endIndex);
                    break;
                case 'instalaciones':
                    displayInstallations(startIndex, endIndex);
                    break;
            }
        }

        // Mostrar soportes paginados
        function displaySupports(startIndex, endIndex) {
            const container = document.getElementById('supportResults');
            const supports = filteredSupports.slice(startIndex, endIndex);
            
            if (supports.length === 0) {
                container.innerHTML = '<div class="no-results">No se encontraron soportes con los filtros aplicados</div>';
                return;
            }
            
            if (showGrouped) {
                container.innerHTML = displayGroupedSupports(supports);
            } else {
                container.innerHTML = supports.map(support => createSupportCard(support)).join('');
            }
        }

        // Mostrar soportes agrupados
        function displayGroupedSupports(supports) {
            const grouped = {};
            
            supports.forEach(support => {
                const groupKey = support.support_number;
                if (!grouped[groupKey]) {
                    grouped[groupKey] = [];
                }
                grouped[groupKey].push(support);
            });
            
            return Object.entries(grouped).map(([groupKey, groupSupports]) => {
                return createGroupedSupportCard(groupKey, groupSupports);
            }).join('');
        }

        // Crear tarjeta de soporte agrupado
        function createGroupedSupportCard(groupKey, groupSupports) {
            const firstSupport = groupSupports[0];
            const count = groupSupports.length;
            
            return `
                <div class="result-card">
                    <h3>üîß Soporte ${groupKey} 
                        <span style="background: #007bff; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8em; margin-left: 10px;">
                            ${count} elemento${count > 1 ? 's' : ''}
                        </span>
                    </h3>
                    <div class="info">
                        <div><strong>Tipo:</strong> ${firstSupport.support_type}</div>
                        <div><strong>L√≠nea:</strong> ${firstSupport.fluid_piping}</div>
                        <div><strong>Clase:</strong> ${firstSupport.material_class}</div>
                        <div><strong>Total Cantidad:</strong> ${groupSupports.reduce((sum, s) => sum + parseInt(s.quantity || 0), 0)}</div>
                    </div>
                    
                    <div class="group-toggle" onclick="toggleGroup('${groupKey}')" style="cursor: pointer; padding: 10px; background: #f8f9fa; border-radius: 8px; margin: 10px 0; text-align: center;">
                        <strong>üëÅÔ∏è Ver Detalles (${count} elementos)</strong>
                    </div>
                    
                    <div id="group-${groupKey}" style="display: none;">
                        ${groupSupports.map(support => createSupportCard(support)).join('')}
                    </div>
                </div>
            `;
        }

        // Alternar grupo
        function toggleGroup(groupKey) {
            const groupDiv = document.getElementById(`group-${groupKey}`);
            const isHidden = groupDiv.style.display === 'none';
            groupDiv.style.display = isHidden ? 'block' : 'none';
        }

        // Crear secci√≥n de variables de plantilla
        function createTemplateVariablesSection(dimensionData) {
            if (!dimensionData || Object.keys(dimensionData).length === 0) {
                return '';
            }
            
            const variables = [];
            
            // Mapeo de t√≠tulos simplificados
            const simpleTitles = {
                'A': 'Altura',
                'B': 'Ancho', 
                'C': 'Profundidad',
                'D': 'Di√°metro',
                'E': 'Espesor',
                'R': 'Radio',
                'X': 'Posici√≥n X',
                'Y': 'Posici√≥n Y',
                'EL': 'Elevaci√≥n',
                'N.': 'N√∫mero',
                'SH.': 'Hoja',
                'TEMP': 'Temperatura'
            };
            
            // Procesar cada variable de dimensi√≥n
            Object.entries(dimensionData).forEach(([key, data]) => {
                if (data && data.value) {
                    variables.push({
                        name: key,
                        title: simpleTitles[key] || key,
                        code: data.reference_code || '',
                        value: data.value,
                        unit: data.unit || ''
                    });
                }
            });
            
            if (variables.length === 0) {
                return '';
            }
            
            return `
                <div class="template-variables-section" style="margin-top: 15px; padding: 15px; background: #fff3cd; border-radius: 10px; border-left: 4px solid #ffc107;">
                    <h4 style="color: #856404; margin-bottom: 10px;">üìê Dimensiones T√©cnicas</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 8px;">
                        ${variables.map(variable => `
                            <div style="background: white; padding: 8px; border-radius: 6px; text-align: center; border: 1px solid #ffeaa7;">
                                <div style="font-weight: bold; color: #856404; font-size: 0.85em; line-height: 1.2;">${variable.title}</div>
                                ${variable.code ? `<div style="font-size: 0.75em; color: #666; margin: 2px 0;">${variable.code}</div>` : ''}
                                <div style="font-size: 1.1em; color: #333; font-weight: bold; margin-top: 4px;">${variable.value}${variable.unit}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        // Mostrar isom√©tricos paginados
        function displayIsometrics(startIndex, endIndex) {
            const container = document.getElementById('isometricResults');
            const isometrics = filteredIsometrics.slice(startIndex, endIndex);
            
            if (isometrics.length === 0) {
                container.innerHTML = '<div class="no-results">No se encontraron isom√©tricos con los filtros aplicados</div>';
                return;
            }
            
            container.innerHTML = isometrics.map(isometric => createIsometricCard(isometric)).join('');
        }

        // Mostrar relaciones paginadas
        function displayRelations(startIndex, endIndex) {
            const container = document.getElementById('relationResults');
            const relations = filteredRelations.slice(startIndex, endIndex);
            
            if (relations.length === 0) {
                container.innerHTML = '<div class="no-results">No se encontraron relaciones con los filtros aplicados</div>';
                return;
            }
            
            // Agrupar por soporte
            const groupedRelations = {};
            relations.forEach(relation => {
                const key = `${relation.support_number}-${relation.support_type}`;
                if (!groupedRelations[key]) {
                    groupedRelations[key] = [];
                }
                groupedRelations[key].push(relation);
            });
            
            container.innerHTML = Object.entries(groupedRelations)
                .map(([key, relationsGroup]) => createRelationCard(key, relationsGroup))
                .join('');
        }

        // Mostrar soldadura paginada
        function displayWelding(startIndex, endIndex) {
            const container = document.getElementById('weldingResults');
            const welding = filteredWelding.slice(startIndex, endIndex);
            
            if (welding.length === 0) {
                container.innerHTML = '<div class="no-results">No se encontraron datos de soldadura con los filtros aplicados</div>';
                return;
            }
            
            container.innerHTML = welding.map(([line, stats]) => createWeldingCard(line, stats)).join('');
        }

        // Mostrar instalaciones paginadas
        function displayInstallations(startIndex, endIndex) {
            const container = document.getElementById('installationResults');
            const installations = filteredInstallations.slice(startIndex, endIndex);
            
            if (installations.length === 0) {
                container.innerHTML = '<div class="no-results">No se encontraron instalaciones con los filtros aplicados</div>';
                return;
            }
            
            container.innerHTML = installations.map(installation => createInstallationCard(installation)).join('');
        }

        // Actualizar paginaci√≥n
        function updatePagination(tabType) {
            const totalResults = getTotalResults(tabType);
            const totalPages = Math.ceil(totalResults / ITEMS_PER_PAGE);
            const currentPageNum = currentPage[tabType];
            
            // Determinar IDs seg√∫n el tipo de tab
            let paginationId, pageInfoId;
            switch(tabType) {
                case 'soportes':
                    paginationId = 'supportPagination';
                    pageInfoId = 'supportPageInfo';
                    break;
                case 'isometricos':
                    paginationId = 'isometricPagination';
                    pageInfoId = 'isometricPageInfo';
                    break;
                case 'relaciones':
                    paginationId = 'relationPagination';
                    pageInfoId = 'relationPageInfo';
                    break;
                case 'soldadura':
                    paginationId = 'weldingPagination';
                    pageInfoId = 'weldingPageInfo';
                    break;
                case 'instalaciones':
                    paginationId = 'installationPagination';
                    pageInfoId = 'installationPageInfo';
                    break;
            }
            
            const pagination = document.getElementById(paginationId);
            const pageInfo = document.getElementById(pageInfoId);
            
            if (totalPages > 1) {
                pagination.style.display = 'flex';
                pageInfo.textContent = `P√°gina ${currentPageNum} de ${totalPages} (${totalResults} resultados)`;
                
                // Actualizar botones
                const prevBtn = pagination.querySelector('.pagination-btn');
                const nextBtn = pagination.querySelector('.pagination-btn:last-child');
                
                prevBtn.disabled = currentPageNum === 1;
                nextBtn.disabled = currentPageNum === totalPages;
            } else {
                pagination.style.display = 'none';
            }
        }

        // Alternar vista agrupada
        function toggleGroupView() {
            showGrouped = !showGrouped;
            const btn = document.getElementById('toggleGroupBtn');
            btn.textContent = showGrouped ? 'üìã Vista Individual' : 'üìä Vista Agrupada';
            
            if (searchPerformed['soportes']) {
                displayResults('soportes');
            }
        }

        // Crear tarjeta de soldadura
        function createWeldingCard(line, stats) {
            const totalWelds = stats.total_welds || 0;
            const completedWelds = stats.completed_welds || 0;
            const pendingWelds = totalWelds - completedWelds;
            const progress = stats.progress_percentage || 0;
            const diameterBreakdown = stats.diameter_breakdown || {};
            
            // Buscar isom√©tricos relacionados
            const relatedIsometrics = weldingData.filter(rel => rel.system_line === line);
            const isometricFiles = relatedIsometrics.length > 0 ? relatedIsometrics[0].isometric_files || [] : [];
            const fluid = relatedIsometrics.length > 0 ? relatedIsometrics[0].fluid || 'N/A' : 'N/A';
            const type = relatedIsometrics.length > 0 ? relatedIsometrics[0].type || 'regular' : 'regular';
            
            // Determinar clase de estado
            const getStatusClass = (progress) => {
                if (progress === 0) return 'status-0';
                if (progress < 25) return 'status-low';
                if (progress < 75) return 'status-medium';
                if (progress < 100) return 'status-high';
                return 'status-complete';
            };
            
            const statusClass = getStatusClass(progress);
            
            // Crear botones de PDFs
            const pdfButtons = [];
            
            // Botones de PDFs regulares
            if (isometricFiles.length > 0) {
                isometricFiles.slice(0, 2).forEach(file => {
                    pdfButtons.push(`
                        <button class="btn btn-sm btn-outline-primary me-1 mb-1" 
                                onclick="openPDF('ISOMETRICOS/${file}')">
                            üìÑ ${file.split('_')[0]}
                        </button>
                    `);
                });
            }
            
            // Bot√≥n de PDF prefabricado
            const prefabButton = createPrefabricatedPDFButtonForLine(line);
            if (prefabButton) {
                pdfButtons.push(prefabButton);
            }
            
            // Bot√≥n para gestionar costuras individuales
            const manageWeldsButton = `
                <button class="btn btn-sm btn-warning me-1 mb-1" 
                        onclick="openWeldsManager('${line}')">
                    <i class="fas fa-cogs me-1"></i>Gestionar Costuras
                </button>
            `;
            
            return `
                <div class="result-card">
                    <h3>‚ö° ${line} 
                        <span class="welding-status-badge ${statusClass}">
                            ${progress}% Completado
                        </span>
                        <span class="type-badge ${type}">${type === 'prefabricated' ? 'üîß Prefabricado' : 'üìê Regular'}</span>
                    </h3>
                    <div class="info">
                        <div><strong>Total Costuras:</strong> ${totalWelds}</div>
                        <div><strong>Completadas:</strong> ${completedWelds}</div>
                        <div><strong>Pendientes:</strong> ${pendingWelds}</div>
                        <div><strong>Progreso:</strong> ${progress}%</div>
                        <div><strong>Fluido:</strong> ${fluid}</div>
                    </div>
                    
                    <div class="welding-progress-bar">
                        <div class="welding-progress-fill" style="width: ${progress}%">
                            ${progress}%
                        </div>
                    </div>
                    
                    <div class="diameter-breakdown">
                        <h4>üìè Desglose por Di√°metro:</h4>
                        ${Object.entries(diameterBreakdown).map(([diameter, data]) => {
                            const diameterProgress = data.total > 0 ? Math.round((data.completed / data.total) * 100) : 0;
                            return `
                                <div class="diameter-item">
                                    <div class="diameter-info">
                                        <div class="diameter-size">${diameter}"</div>
                                        <div class="diameter-details">${data.completed}/${data.total} costuras</div>
                                    </div>
                                    <div class="welding-status-badge ${getStatusClass(diameterProgress)}">
                                        ${diameterProgress}%
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    
                    <div class="welding-actions">
                        <h4>üîß Acciones:</h4>
                        <div class="action-buttons">
                            ${pdfButtons.join('')}
                            ${manageWeldsButton}
                        </div>
                    </div>
                    
                    ${isometricFiles.length > 0 ? `
                        <div class="isometric-files">
                            <h4>üìã Isom√©tricos Relacionados:</h4>
                            <div class="file-list">
                                ${isometricFiles.slice(0, 3).map(file => `
                                    <a href="ISOMETRICOS/${file}" target="_blank" class="isometric-file">${file}</a>
                                `).join('')}
                                ${isometricFiles.length > 3 ? `<span class="more-files">+${isometricFiles.length - 3} m√°s</span>` : ''}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
        }
        
        // Crear bot√≥n para PDF prefabricado por l√≠nea
        function createPrefabricatedPDFButtonForLine(lineCode) {
            // Buscar correspondencia en el mapeo de prefabricados
            for (const [normalFile, prefabInfo] of Object.entries(prefabricatedMapping)) {
                if (prefabInfo.line_code === lineCode) {
                    return `
                        <button class="btn btn-sm btn-outline-success me-1 mb-1" 
                                onclick="openPDF('${prefabInfo.prefab_path}')">
                            üìÑ PDF Prefabricado: ${prefabInfo.prefab_file}
                        </button>
                    `;
                }
            }
            return null;
        }
        
        // Abrir gestor de costuras para una l√≠nea espec√≠fica
        function openWeldsManager(lineCode) {
            // Buscar todas las costuras de esta l√≠nea
            const lineWelds = weldingData.filter(rel => rel.system_line === lineCode);
            
            if (lineWelds.length === 0) {
                showNotification('No se encontraron costuras para esta l√≠nea', 'warning');
                return;
            }
            
            // Crear modal con tabla de costuras
            const modal = document.createElement('div');
            modal.className = 'modal fade show';
            modal.style.display = 'block';
            modal.style.backgroundColor = 'rgba(0,0,0,0.5)';
            
            // Crear filas de la tabla
            const weldsRows = lineWelds.map((weld, index) => {
                const weldData = weld.weld_data || {};
                const currentStatus = weldData.status || 'pendiente';
                const weldId = `${weld.welding_isometric}_${weldData.weld_number || index}_${weldData.diameter || 0}`;
                
                // Opciones de estado
                const statusOptions = [
                    { value: 'pendiente', label: 'Pendiente', color: '#ffc107', icon: '‚è≥' },
                    { value: 'en_progreso', label: 'En Progreso', color: '#17a2b8', icon: 'üîÑ' },
                    { value: 'completada', label: 'Completada', color: '#28a745', icon: '‚úÖ' },
                    { value: 'inspeccion', label: 'En Inspecci√≥n', color: '#fd7e14', icon: 'üîç' },
                    { value: 'rechazada', label: 'Rechazada', color: '#dc3545', icon: '‚ùå' }
                ];
                
                const statusSelect = statusOptions.map(option => 
                    `<option value="${option.value}" ${currentStatus === option.value ? 'selected' : ''}>
                        ${option.icon} ${option.label}
                    </option>`
                ).join('');
                
                return `
                                                        <tr id="weld_row_${index}" onclick="selectRow(${index})" class="clickable-row">
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <input type="checkbox" class="form-check-input me-2" 
                                                       id="check_${index}" 
                                                       onchange="toggleRowSelection(${index})"
                                                       onclick="event.stopPropagation()">
                                                <span class="row-number">${index + 1}</span>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="isometric-info">
                                                <strong>${weld.welding_isometric}</strong>
                                                <small class="text-muted d-block">L√≠nea: ${weld.system_line}</small>
                                            </div>
                                        </td>
                                        <td class="text-center">
                                            <span class="diameter-badge">${weldData.diameter || 0}"</span>
                                        </td>
                                        <td class="text-center">
                                            <div class="progress-container">
                                                <div class="progress-circle" data-progress="${weldData.completion_percentage || 0}">
                                                    <span>${weldData.completion_percentage || 0}%</span>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="text-center">
                                            <select class="form-select form-select-sm status-select" 
                                                    data-weld-id="${weldId}" 
                                                    data-row-index="${index}"
                                                    onchange="updateWeldStatus('${weldId}', this.value, ${index})"
                                                    onclick="event.stopPropagation()">
                                                ${statusSelect}
                                            </select>
                                        </td>
                                        <td class="text-center">
                                            <input type="text" class="form-control form-control-sm comment-input" 
                                                   placeholder="Comentario..."
                                                   id="comment_${index}"
                                                   maxlength="100"
                                                   onclick="event.stopPropagation()"
                                                   onkeypress="handleCommentKeyPress(event, '${weldId}', ${index})">
                                        </td>
                                        <td class="text-center">
                                            <div class="action-buttons-container">
                                                <button class="btn btn-sm btn-success action-btn" 
                                                        onclick="saveWeldChanges('${weldId}', ${index}); event.stopPropagation()"
                                                        title="Guardar cambios">
                                                    <i class="fas fa-save"></i>
                                                </button>
                                                <button class="btn btn-sm btn-info action-btn" 
                                                        onclick="quickStatusChange('${weldId}', ${index}, 'completada'); event.stopPropagation()"
                                                        title="Marcar como completada">
                                                    <i class="fas fa-check"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                `;
            }).join('');
            
            modal.innerHTML = `
                <div class="modal-dialog modal-xl">
                    <div class="modal-content">
                        <div class="modal-header bg-primary text-white">
                            <h5 class="modal-title">
                                <i class="fas fa-table me-2"></i>
                                Gesti√≥n de Costuras - L√≠nea ${lineCode}
                            </h5>
                            <button type="button" class="btn-close btn-close-white" onclick="this.closest('.modal').remove()"></button>
                        </div>
                        <div class="modal-body" style="max-height: 600px; overflow-y: auto;">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <h6><i class="fas fa-info-circle me-2"></i>Informaci√≥n General</h6>
                                    <p class="mb-1"><strong>L√≠nea:</strong> ${lineCode}</p>
                                    <p class="mb-1"><strong>Total de costuras:</strong> ${lineWelds.length}</p>
                                    <div class="live-stats mt-2" id="liveStats">
                                        <div class="stats-grid">
                                            <div class="stat-item stat-pending">
                                                <span class="stat-number" id="pendingCount">0</span>
                                                <span class="stat-label">Pendientes</span>
                                            </div>
                                            <div class="stat-item stat-progress">
                                                <span class="stat-number" id="progressCount">0</span>
                                                <span class="stat-label">En Progreso</span>
                                            </div>
                                            <div class="stat-item stat-completed">
                                                <span class="stat-number" id="completedCount">0</span>
                                                <span class="stat-label">Completadas</span>
                                            </div>
                                            <div class="stat-item stat-inspection">
                                                <span class="stat-number" id="inspectionCount">0</span>
                                                <span class="stat-label">Inspecci√≥n</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <h6><i class="fas fa-chart-pie me-2"></i>Acciones R√°pidas</h6>
                                    <div class="btn-group me-2" role="group">
                                        <button class="btn btn-sm btn-success" onclick="markAllAsCompleted('${lineCode}')">
                                            <i class="fas fa-check-double me-1"></i>Todo Completado
                                        </button>
                                        <button class="btn btn-sm btn-info" onclick="markAllAsInProgress('${lineCode}')">
                                            <i class="fas fa-play me-1"></i>Todo En Progreso
                                        </button>
                                    </div>
                                    <div class="btn-group" role="group">
                                        <button class="btn btn-sm btn-warning" onclick="saveAllChanges('${lineCode}')">
                                            <i class="fas fa-save me-1"></i>Guardar Todos
                                        </button>
                                        <button class="btn btn-sm btn-secondary" onclick="resetAllChanges('${lineCode}')">
                                            <i class="fas fa-undo me-1"></i>Resetear
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="table-responsive">
                                <table class="table table-striped table-hover">
                                    <thead class="table-dark">
                                        <tr>
                                            <th width="5%">#</th>
                                            <th width="25%">Isom√©trico</th>
                                            <th width="10%" class="text-center">Di√°metro</th>
                                            <th width="10%" class="text-center">Progreso</th>
                                            <th width="20%" class="text-center">Estado</th>
                                            <th width="20%" class="text-center">Comentario</th>
                                            <th width="10%" class="text-center">Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${weldsRows}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" onclick="this.closest('.modal').remove()">
                                <i class="fas fa-times me-1"></i>Cerrar
                            </button>
                            <button type="button" class="btn btn-primary" onclick="saveAllChanges('${lineCode}')">
                                <i class="fas fa-save me-1"></i>Guardar Todos los Cambios
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Actualizar estad√≠sticas iniciales
            updateLiveStats();
            
            // Remover modal al hacer clic fuera
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        // Actualizar estad√≠sticas en tiempo real
        function updateLiveStats() {
            const modal = document.querySelector('.modal');
            if (!modal) return;
            
            const statusSelects = modal.querySelectorAll('.status-select');
            const stats = {
                pendiente: 0,
                en_progreso: 0,
                completada: 0,
                inspeccion: 0,
                rechazada: 0
            };
            
            statusSelects.forEach(select => {
                const status = select.value;
                if (stats.hasOwnProperty(status)) {
                    stats[status]++;
                }
            });
            
            // Actualizar contadores
            const pendingEl = modal.querySelector('#pendingCount');
            const progressEl = modal.querySelector('#progressCount');
            const completedEl = modal.querySelector('#completedCount');
            const inspectionEl = modal.querySelector('#inspectionCount');
            
            if (pendingEl) pendingEl.textContent = stats.pendiente;
            if (progressEl) progressEl.textContent = stats.en_progreso;
            if (completedEl) completedEl.textContent = stats.completada;
            if (inspectionEl) inspectionEl.textContent = stats.inspeccion;
            
            // Calcular progreso general
            const total = statusSelects.length;
            const completed = stats.completada;
            const progress = total > 0 ? Math.round((completed / total) * 100) : 0;
            
            // Actualizar barra de progreso si existe
            let progressBar = modal.querySelector('.overall-progress');
            if (!progressBar) {
                progressBar = document.createElement('div');
                progressBar.className = 'overall-progress mt-2';
                progressBar.innerHTML = `
                    <div class="progress-label d-flex justify-content-between">
                        <span><i class="fas fa-chart-line me-1"></i>Progreso General</span>
                        <span class="progress-percentage fw-bold">${progress}%</span>
                    </div>
                    <div class="progress mt-1">
                        <div class="progress-bar bg-success progress-bar-striped progress-bar-animated" 
                             style="width: ${progress}%"></div>
                    </div>
                `;
                modal.querySelector('.live-stats').appendChild(progressBar);
            } else {
                progressBar.querySelector('.progress-percentage').textContent = `${progress}%`;
                progressBar.querySelector('.progress-bar').style.width = `${progress}%`;
            }
        }
        
        // Abrir modal de estado de soldadura
        function openWeldingStatusModal(weldId, weldData) {
            try {
                // Usar el gestor de estado si est√° disponible
                if (window.weldingStatusManager && window.weldingStatusManager.isInitialized) {
                    window.weldingStatusManager.openStatusModal(weldId);
                } else {
                    // Fallback: modal simple
                    showSimpleStatusModal(weldId, weldData);
                }
            } catch (error) {
                console.error('Error abriendo modal de estado:', error);
                showNotification('Error al abrir el modal de estado', 'error');
            }
        }
        
        // Modal simple como fallback
        function showSimpleStatusModal(weldId, weldData) {
            const modal = document.createElement('div');
            modal.className = 'modal fade show';
            modal.style.display = 'block';
            modal.style.backgroundColor = 'rgba(0,0,0,0.5)';
            
            const statusOptions = [
                { value: 'pendiente', label: 'Pendiente', color: '#ffc107', icon: '‚è≥' },
                { value: 'en_progreso', label: 'En Progreso', color: '#17a2b8', icon: 'üîÑ' },
                { value: 'completada', label: 'Completada', color: '#28a745', icon: '‚úÖ' },
                { value: 'inspeccion', label: 'En Inspecci√≥n', color: '#fd7e14', icon: 'üîç' },
                { value: 'rechazada', label: 'Rechazada', color: '#dc3545', icon: '‚ùå' }
            ];
            
            const statusOptionsHtml = statusOptions.map(option => `
                <div class="form-check mb-2">
                    <input class="form-check-input" type="radio" name="weldStatus" 
                           id="status_${option.value}" value="${option.value}" 
                           ${(weldData.weld_data?.status || 'pendiente') === option.value ? 'checked' : ''}>
                    <label class="form-check-label d-flex align-items-center" for="status_${option.value}">
                        <span class="me-2" style="font-size: 1.2em;">${option.icon}</span>
                        <div>
                            <strong style="color: ${option.color};">${option.label}</strong>
                        </div>
                    </label>
                </div>
            `).join('');
            
            modal.innerHTML = `
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header bg-primary text-white">
                            <h5 class="modal-title">
                                <i class="fas fa-edit me-2"></i>
                                Modificar Estado de Costura
                            </h5>
                            <button type="button" class="btn-close btn-close-white" onclick="this.closest('.modal').remove()"></button>
                        </div>
                        <div class="modal-body">
                            <div class="mb-3">
                                <h6>üìã Informaci√≥n de la Costura</h6>
                                <p><strong>Isom√©trico:</strong> ${weldData.welding_isometric}</p>
                                <p><strong>Di√°metro:</strong> ${weldData.weld_data?.diameter || 0}"</p>
                                <p><strong>L√≠nea:</strong> ${weldData.system_line}</p>
                                <p><strong>Progreso:</strong> ${weldData.weld_data?.completion_percentage || 0}%</p>
                            </div>
                            
                            <div class="mb-3">
                                <h6>‚öôÔ∏è Cambiar Estado</h6>
                                ${statusOptionsHtml}
                            </div>
                            
                            <div class="mb-3">
                                <label for="statusComment" class="form-label">
                                    <i class="fas fa-comment me-1"></i>
                                    Comentario (opcional)
                                </label>
                                <textarea class="form-control" id="statusComment" rows="3" 
                                          placeholder="Agregar comentario sobre el cambio..."></textarea>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" onclick="this.closest('.modal').remove()">
                                Cancelar
                            </button>
                            <button type="button" class="btn btn-primary" onclick="saveSimpleStatusChange('${weldId}', this)">
                                <i class="fas fa-save me-1"></i>Guardar Cambios
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Remover modal al hacer clic fuera
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }
        
        // Guardar cambio simple de estado
        function saveSimpleStatusChange(weldId, button) {
            const modal = button.closest('.modal');
            const selectedStatus = modal.querySelector('input[name="weldStatus"]:checked');
            const comment = modal.querySelector('#statusComment').value;
            
            if (!selectedStatus) {
                showNotification('Selecciona un estado', 'error');
                return;
            }
            
            const newStatus = selectedStatus.value;
            const statusLabel = selectedStatus.nextElementSibling.textContent.trim();
            
            // Simular guardado (en producci√≥n se enviar√≠a al servidor)
            console.log(`Estado cambiado para ${weldId}: ${newStatus}`, { comment });
            
            showNotification(`Estado cambiado a "${statusLabel}"`, 'success');
            modal.remove();
        }

        // Actualizar estado de costura individual
        function updateWeldStatus(weldId, newStatus, rowIndex) {
            const row = document.getElementById(`weld_row_${rowIndex}`);
            if (row) {
                // Cambiar color de fondo seg√∫n el estado
                const statusColors = {
                    'pendiente': '#fff3cd',
                    'en_progreso': '#d1ecf1',
                    'completada': '#d4edda',
                    'inspeccion': '#ffeaa7',
                    'rechazada': '#f8d7da'
                };
                
                row.style.backgroundColor = statusColors[newStatus] || '#ffffff';
                
                // Marcar como modificado
                row.classList.add('modified');
                
                // Actualizar estad√≠sticas en tiempo real
                updateLiveStats();
                
                console.log(`Estado actualizado para ${weldId}: ${newStatus}`);
            }
        }

        // Guardar cambios de una costura espec√≠fica
        function saveWeldChanges(weldId, rowIndex) {
            const row = document.getElementById(`weld_row_${rowIndex}`);
            const statusSelect = row.querySelector('.status-select');
            const commentInput = row.querySelector(`#comment_${rowIndex}`);
            
            const newStatus = statusSelect.value;
            const comment = commentInput.value.trim();
            
            // Simular guardado (en producci√≥n se enviar√≠a al servidor)
            const changeData = {
                weldId: weldId,
                newStatus: newStatus,
                comment: comment,
                timestamp: new Date().toISOString()
            };
            
            console.log('Guardando cambios de costura:', changeData);
            
            // Actualizar visualmente
            row.classList.remove('modified');
            row.classList.add('saved');
            
            // Mostrar notificaci√≥n
            const statusLabels = {
                'pendiente': 'Pendiente',
                'en_progreso': 'En Progreso',
                'completada': 'Completada',
                'inspeccion': 'En Inspecci√≥n',
                'rechazada': 'Rechazada'
            };
            
            showNotification(`Costura ${rowIndex + 1} actualizada a "${statusLabels[newStatus]}"`, 'success');
            
            // Limpiar el comentario despu√©s de guardar
            commentInput.value = '';
            
            setTimeout(() => {
                row.classList.remove('saved');
            }, 2000);
        }

        // Marcar todas las costuras como completadas
        function markAllAsCompleted(lineCode) {
            const modal = document.querySelector('.modal');
            const statusSelects = modal.querySelectorAll('.status-select');
            
            statusSelects.forEach((select, index) => {
                select.value = 'completada';
                updateWeldStatus(select.dataset.weldId, 'completada', index);
            });
            
            showNotification(`Todas las costuras de ${lineCode} marcadas como completadas`, 'success');
        }

        // Guardar todos los cambios
        function saveAllChanges(lineCode) {
            const modal = document.querySelector('.modal');
            const modifiedRows = modal.querySelectorAll('.modified');
            
            if (modifiedRows.length === 0) {
                showNotification('No hay cambios para guardar', 'info');
                return;
            }
            
            let savedCount = 0;
            modifiedRows.forEach((row, index) => {
                const rowIndex = row.id.split('_')[2];
                const statusSelect = row.querySelector('.status-select');
                const weldId = statusSelect.dataset.weldId;
                
                // Simular guardado
                saveWeldChanges(weldId, parseInt(rowIndex));
                savedCount++;
            });
            
            showNotification(`${savedCount} cambios guardados exitosamente para ${lineCode}`, 'success');
        }

        // Marcar todas las costuras como en progreso
        function markAllAsInProgress(lineCode) {
            const modal = document.querySelector('.modal');
            const statusSelects = modal.querySelectorAll('.status-select');
            
            statusSelects.forEach((select, index) => {
                select.value = 'en_progreso';
                updateWeldStatus(select.dataset.weldId, 'en_progreso', index);
            });
            
            showNotification(`Todas las costuras de ${lineCode} marcadas como en progreso`, 'info');
        }

        // Resetear todos los cambios
        function resetAllChanges(lineCode) {
            const modal = document.querySelector('.modal');
            const modifiedRows = modal.querySelectorAll('.modified');
            
            if (modifiedRows.length === 0) {
                showNotification('No hay cambios para resetear', 'info');
                return;
            }
            
            modifiedRows.forEach(row => {
                row.classList.remove('modified');
                row.style.backgroundColor = '';
                
                // Resetear comentario
                const commentInput = row.querySelector('.comment-input');
                if (commentInput) commentInput.value = '';
            });
            
            showNotification(`Cambios reseteados para ${lineCode}`, 'warning');
        }

        // Seleccionar fila
        function selectRow(index) {
            const row = document.getElementById(`weld_row_${index}`);
            const checkbox = document.getElementById(`check_${index}`);
            
            if (row && checkbox) {
                checkbox.checked = !checkbox.checked;
                toggleRowSelection(index);
            }
        }

        // Alternar selecci√≥n de fila
        function toggleRowSelection(index) {
            const row = document.getElementById(`weld_row_${index}`);
            const checkbox = document.getElementById(`check_${index}`);
            
            if (row && checkbox) {
                if (checkbox.checked) {
                    row.classList.add('selected-row');
                } else {
                    row.classList.remove('selected-row');
                }
                
                updateSelectionCounter();
            }
        }

        // Actualizar contador de selecci√≥n
        function updateSelectionCounter() {
            const modal = document.querySelector('.modal');
            const selectedRows = modal.querySelectorAll('.selected-row');
            const totalRows = modal.querySelectorAll('.clickable-row');
            
            // Crear o actualizar contador si no existe
            let counter = modal.querySelector('.selection-counter');
            if (!counter) {
                counter = document.createElement('div');
                counter.className = 'selection-counter alert alert-info mt-2';
                const infoSection = modal.querySelector('.row.mb-3');
                infoSection.appendChild(counter);
            }
            
            if (selectedRows.length > 0) {
                counter.innerHTML = `
                    <i class="fas fa-check-square me-2"></i>
                    ${selectedRows.length} de ${totalRows.length} costuras seleccionadas
                    <button class="btn btn-sm btn-outline-primary ms-2" onclick="processSelectedRows()">
                        <i class="fas fa-cogs me-1"></i>Procesar Seleccionadas
                    </button>
                    <button class="btn btn-sm btn-outline-secondary ms-1" onclick="clearSelection()">
                        <i class="fas fa-times me-1"></i>Limpiar
                    </button>
                `;
                counter.style.display = 'block';
            } else {
                counter.style.display = 'none';
            }
        }

        // Procesar filas seleccionadas
        function processSelectedRows() {
            const modal = document.querySelector('.modal');
            const selectedRows = modal.querySelectorAll('.selected-row');
            
            if (selectedRows.length === 0) {
                showNotification('No hay filas seleccionadas', 'warning');
                return;
            }
            
            // Crear modal de acci√≥n r√°pida
            const actionModal = document.createElement('div');
            actionModal.className = 'modal fade show';
            actionModal.style.display = 'block';
            actionModal.style.backgroundColor = 'rgba(0,0,0,0.7)';
            actionModal.style.zIndex = '9999';
            
            actionModal.innerHTML = `
                <div class="modal-dialog modal-sm">
                    <div class="modal-content">
                        <div class="modal-header bg-primary text-white">
                            <h6 class="modal-title">
                                <i class="fas fa-bolt me-2"></i>Acci√≥n R√°pida
                            </h6>
                            <button type="button" class="btn-close btn-close-white" onclick="this.closest('.modal').remove()"></button>
                        </div>
                        <div class="modal-body text-center">
                            <p><strong>${selectedRows.length} costuras seleccionadas</strong></p>
                            <div class="d-grid gap-2">
                                <button class="btn btn-success" onclick="applyBulkStatus('completada'); this.closest('.modal').remove()">
                                    <i class="fas fa-check me-1"></i>Marcar Completadas
                                </button>
                                <button class="btn btn-info" onclick="applyBulkStatus('en_progreso'); this.closest('.modal').remove()">
                                    <i class="fas fa-play me-1"></i>Marcar En Progreso
                                </button>
                                <button class="btn btn-warning" onclick="applyBulkStatus('inspeccion'); this.closest('.modal').remove()">
                                    <i class="fas fa-search me-1"></i>Marcar En Inspecci√≥n
                                </button>
                                <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">
                                    <i class="fas fa-times me-1"></i>Cancelar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(actionModal);
        }

        // Aplicar estado masivo
        function applyBulkStatus(status) {
            const modal = document.querySelector('.modal');
            const selectedRows = modal.querySelectorAll('.selected-row');
            
            selectedRows.forEach(row => {
                const rowIndex = row.id.split('_')[2];
                const statusSelect = row.querySelector('.status-select');
                const weldId = statusSelect.dataset.weldId;
                
                statusSelect.value = status;
                updateWeldStatus(weldId, status, parseInt(rowIndex));
            });
            
            const statusLabels = {
                'completada': 'Completadas',
                'en_progreso': 'En Progreso',
                'inspeccion': 'En Inspecci√≥n'
            };
            
            showNotification(`${selectedRows.length} costuras marcadas como ${statusLabels[status]}`, 'success');
            clearSelection();
        }

        // Limpiar selecci√≥n
        function clearSelection() {
            const modal = document.querySelector('.modal');
            const selectedRows = modal.querySelectorAll('.selected-row');
            const checkboxes = modal.querySelectorAll('input[type="checkbox"]');
            
            selectedRows.forEach(row => row.classList.remove('selected-row'));
            checkboxes.forEach(checkbox => checkbox.checked = false);
            
            updateSelectionCounter();
        }

        // Cambio r√°pido de estado
        function quickStatusChange(weldId, rowIndex, status) {
            const row = document.getElementById(`weld_row_${rowIndex}`);
            const statusSelect = row.querySelector('.status-select');
            
            statusSelect.value = status;
            updateWeldStatus(weldId, status, rowIndex);
            
            // Auto-guardar despu√©s de cambio r√°pido
            setTimeout(() => {
                saveWeldChanges(weldId, rowIndex);
            }, 500);
        }

        // Manejar Enter en comentarios
        function handleCommentKeyPress(event, weldId, rowIndex) {
            if (event.key === 'Enter') {
                event.preventDefault();
                saveWeldChanges(weldId, rowIndex);
            }
        }

        // Exportar datos de soldadura
        function exportWeldingData() {
            if (filteredWelding.length === 0) {
                alert('No hay datos de soldadura para exportar. Realiza una b√∫squeda primero.');
                return;
            }
            
            const csvData = [];
            csvData.push(['L√≠nea', 'Total Costuras', 'Costuras Completadas', 'Costuras Pendientes', 'Progreso %', 'Fluido', 'Tipo']);
            
            filteredWelding.forEach(([line, stats]) => {
                const totalWelds = stats.total_welds || 0;
                const completedWelds = stats.completed_welds || 0;
                const pendingWelds = totalWelds - completedWelds;
                const progress = stats.progress_percentage || 0;
                
                // Buscar informaci√≥n adicional
                const relatedIsometrics = weldingData.filter(rel => rel.system_line === line);
                const fluid = relatedIsometrics.length > 0 ? relatedIsometrics[0].fluid || 'N/A' : 'N/A';
                const type = relatedIsometrics.length > 0 ? relatedIsometrics[0].type || 'regular' : 'regular';
                
                csvData.push([line, totalWelds, completedWelds, pendingWelds, progress, fluid, type]);
            });
            
            const csv = csvData.map(row => row.join(',')).join('\\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `soldadura_${new Date().toISOString().slice(0, 10)}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        // Crear tarjeta de soporte con informaci√≥n de instalaci√≥n
        function createSupportCard(support) {
            const pdfs = supportMapping[support.support_type] || [];
            const pdfLinks = pdfs.map(pdf => 
                `<a href="ESTANDARES DE SOPORTES/${pdf}" target="_blank" class="isometric-file">${pdf}</a>`
            ).join('');
            
            // Buscar isom√©tricos relacionados
            const relatedIsometrics = supportIsometricRelations.filter(r => 
                r.support_number === support.support_number && r.support_type === support.support_type
            );
            
            // Obtener informaci√≥n de instalaci√≥n
            const installationInfo = window.installationManager ? 
                window.installationManager.getInstallationInfo(support) : 
                { status: 'pending', planned_date: null, actual_date: null, notes: '', installed_by: '' };
            
            // Obtener variables de plantilla
            const dimensionKey = `${support.support_number}-${support.support_type}`;
            const dimensionData = supportDimensions[dimensionKey] || {};
            const templateSection = createTemplateVariablesSection(dimensionData);
            
            const isometricSection = relatedIsometrics.length > 0 ? `
                <div class="isometric-section">
                    <h4>üìê Isom√©tricos Relacionados:</h4>
                    <div class="isometric-files">
                        ${relatedIsometrics[0].isometric_files.map(file => 
                            `<a href="ISOMETRICOS/${file}" target="_blank" class="isometric-file">${file.split('_')[0]}</a>`
                        ).join('')}
    </div>
                    <div style="margin-top: 10px;">
                        <strong>L√≠nea:</strong> ${relatedIsometrics[0].line_code} | 
                        <strong>Fluido:</strong> ${relatedIsometrics[0].fluid} | 
                        <strong>Hoja ISO:</strong> ${relatedIsometrics[0].iso_sheet}
                    </div>
                </div>
            ` : '';
            
            const installationSection = createInstallationSection(support, installationInfo);
            
            return `
                <div class="result-card">
                    <h3>üîß Soporte ${support.support_number}${createInstallationStatusBadge(installationInfo)}</h3>
                    <div class="info">
                        <div><strong>Tipo:</strong> ${support.support_type}</div>
                        <div><strong>L√≠nea:</strong> ${support.fluid_piping}</div>
                        <div><strong>Posici√≥n:</strong> ${support.position_number}</div>
                        <div><strong>Cantidad:</strong> ${support.quantity}</div>
                        <div><strong>Clase:</strong> ${support.material_class}</div>
                        <div><strong>Dimensiones:</strong> ${support.size_dimensions}</div>
            </div>
                    ${templateSection}
                    ${pdfLinks ? `
                        <div class="isometric-section">
                            <h4>üìã PDFs de Est√°ndares:</h4>
                            <div class="isometric-files">${pdfLinks}</div>
                        </div>
                    ` : ''}
                    ${isometricSection}
                    ${installationSection}
                </div>
            `;
        }

        // Crear badge de estado de instalaci√≥n
        function createInstallationStatusBadge(installationInfo) {
            if (!window.installationManager) return '';
            
            const statusText = getStatusText(installationInfo.status);
            const statusIcon = getStatusIcon(installationInfo.status);
            
            let overdueIndicator = '';
            if (isOverdue(installationInfo.planned_date, installationInfo.status)) {
                overdueIndicator = '<span class="overdue-indicator">ATRASADO</span>';
            }
            
            return `
                <span class="installation-status status-${installationInfo.status}">
                    ${statusIcon} ${statusText}
                </span>
                ${overdueIndicator}
            `;
        }

        // Crear secci√≥n de instalaci√≥n para soportes
        function createInstallationSection(support, installationInfo) {
            const plannedDate = installationInfo.planned_date ? 
                new Date(installationInfo.planned_date).toLocaleDateString() : 'No definida';
            const actualDate = installationInfo.actual_date ? 
                new Date(installationInfo.actual_date).toLocaleDateString() : 'No instalado';
            
            return `
                <div class="installation-section">
                    <h4>üîß Estado de Instalaci√≥n</h4>
                    <div class="installation-details">
                        <div><strong>Estado:</strong> ${getStatusText(installationInfo.status)}</div>
                        <div><strong>Planificado:</strong> ${plannedDate}</div>
                        <div><strong>Instalado:</strong> ${actualDate}</div>
                        <div><strong>Responsable:</strong> ${installationInfo.installed_by || 'No asignado'}</div>
                    </div>
                    ${installationInfo.notes ? `<div><strong>Notas:</strong> ${installationInfo.notes}</div>` : ''}
                    <div class="installation-controls">
                        <button class="install-btn" onclick="editInstallation('${support.support_number}', '${support.support_type}', '${support.position_number || '1'}')">
                            ‚úèÔ∏è Editar
                    </button>
                        <button class="install-btn" onclick="quickInstall('${support.support_number}', '${support.support_type}', '${support.position_number || '1'}')">
                            ‚úÖ Marcar Instalado
                    </button>
                </div>
                </div>
            `;
        }

        // Crear tarjeta de instalaci√≥n
        function createInstallationCard(installation) {
            const support = allSupports.find(s => 
                s.support_number === installation.support_number && 
                s.support_type === installation.support_type
            );
            
            const plannedDate = installation.planned_date ? 
                new Date(installation.planned_date).toLocaleDateString() : 'No definida';
            const actualDate = installation.actual_date ? 
                new Date(installation.actual_date).toLocaleDateString() : 'No instalado';
            
            return `
                <div class="result-card">
                    <h3>üîß ${installation.support_number} - ${installation.support_type}${createInstallationStatusBadge(installation)}</h3>
                    <div class="info">
                        <div><strong>Estado:</strong> ${getStatusText(installation.status)}</div>
                        <div><strong>Planificado:</strong> ${plannedDate}</div>
                        <div><strong>Instalado:</strong> ${actualDate}</div>
                        <div><strong>Responsable:</strong> ${installation.installed_by || 'No asignado'}</div>
                        <div><strong>L√≠nea:</strong> ${support ? support.fluid_piping : 'N/A'}</div>
                        <div><strong>Posici√≥n:</strong> ${installation.position_number || 'N/A'}</div>
                    </div>
                    ${installation.notes ? `
                        <div style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                            <strong>Notas:</strong> ${installation.notes}
                </div>
                    ` : ''}
                    <div class="installation-controls">
                        <button class="install-btn" onclick="editInstallation('${installation.support_number}', '${installation.support_type}', '${installation.position_number || '1'}')">
                            ‚úèÔ∏è Editar
                        </button>
                        ${installation.status !== 'installed' ? `
                            <button class="install-btn" onclick="quickInstall('${installation.support_number}', '${installation.support_type}', '${installation.position_number || '1'}')">
                                ‚úÖ Marcar Instalado
                            </button>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        // Editar instalaci√≥n
        function editInstallation(supportNumber, supportType, positionNumber) {
            if (!window.installationManager) return;
            
            const support = allSupports.find(s => 
                s.support_number === supportNumber && 
                s.support_type === supportType && 
                (s.position_number || '1') === positionNumber
            );
            
            if (!support) {
                alert('Soporte no encontrado');
                return;
            }
            
            currentEditingSupport = support;
            const installationInfo = window.installationManager.getInstallationInfo(support);
            
            // Llenar el formulario
            document.getElementById('modalSupportInfo').value = `${support.support_number} - ${support.support_type} (Pos. ${support.position_number || '1'})`;
            document.getElementById('modalInstallationStatus').value = installationInfo.status;
            document.getElementById('modalPlannedDate').value = installationInfo.planned_date ? 
                formatDateForInput(installationInfo.planned_date) : '';
            document.getElementById('modalActualDate').value = installationInfo.actual_date ? 
                formatDateForInput(installationInfo.actual_date) : '';
            document.getElementById('modalInstalledBy').value = installationInfo.installed_by || '';
            document.getElementById('modalInstallationNotes').value = installationInfo.notes || '';
            
            // Mostrar/ocultar campos seg√∫n el estado
            toggleDateFields();
            
            // Mostrar modal
            document.getElementById('editInstallationModal').style.display = 'block';
        }

        // Instalaci√≥n r√°pida
        function quickInstall(supportNumber, supportType, positionNumber) {
            if (!window.installationManager) return;
            
            const support = allSupports.find(s => 
                s.support_number === supportNumber && 
                s.support_type === supportType && 
                (s.position_number || '1') === positionNumber
            );
            
            if (!support) {
                alert('Soporte no encontrado');
                return;
            }
            
            const responsable = prompt('Ingrese el nombre del responsable de la instalaci√≥n:');
            if (responsable !== null) {
                window.installationManager.markAsInstalled(support, responsable, 'Instalaci√≥n r√°pida');
                
                // Refrescar la vista actual
                if (currentTab === 'soportes' && searchPerformed.soportes) {
                    performSearch('soportes');
                } else if (currentTab === 'instalaciones' && searchPerformed.instalaciones) {
                    performSearch('instalaciones');
                }
                
                updateStats();
                alert('‚úÖ Soporte marcado como instalado');
            }
        }

        // Guardar instalaci√≥n desde el modal
        function saveInstallation() {
            if (!currentEditingSupport || !window.installationManager) return;
            
            const status = document.getElementById('modalInstallationStatus').value;
            const plannedDate = document.getElementById('modalPlannedDate').value;
            const actualDate = document.getElementById('modalActualDate').value;
            const installedBy = document.getElementById('modalInstalledBy').value;
            const notes = document.getElementById('modalInstallationNotes').value;
            
            const updateData = {
                status: status,
                planned_date: plannedDate ? new Date(plannedDate).toISOString() : null,
                actual_date: actualDate ? new Date(actualDate).toISOString() : null,
                installed_by: installedBy,
                notes: notes
            };
            
            window.installationManager.updateInstallation(currentEditingSupport, updateData);
            
            // Cerrar modal
            closeModal();
            
            // Refrescar la vista actual
            if (currentTab === 'soportes' && searchPerformed.soportes) {
                performSearch('soportes');
            } else if (currentTab === 'instalaciones' && searchPerformed.instalaciones) {
                performSearch('instalaciones');
            }
            
            updateStats();
            alert('‚úÖ Informaci√≥n de instalaci√≥n guardada');
        }

        // Cerrar modal
        function closeModal() {
            document.getElementById('editInstallationModal').style.display = 'none';
            currentEditingSupport = null;
        }

        // Alternar campos de fecha seg√∫n el estado
        function toggleDateFields() {
            const status = document.getElementById('modalInstallationStatus').value;
            const plannedDateGroup = document.getElementById('modalPlannedDate').parentElement;
            const actualDateGroup = document.getElementById('modalActualDate').parentElement;
            const installedByGroup = document.getElementById('modalInstalledBy').parentElement;
            
            // Mostrar fecha planificada para estados 'planned' e 'in_progress'
            plannedDateGroup.style.display = ['planned', 'in_progress'].includes(status) ? 'block' : 'none';
            
            // Mostrar fecha real e instalado por para estado 'installed'
            actualDateGroup.style.display = status === 'installed' ? 'block' : 'none';
            installedByGroup.style.display = status === 'installed' ? 'block' : 'none';
        }

        // Exportar instalaciones
        function exportInstallations() {
            if (!window.installationManager) return;
            
            const data = window.installationManager.exportData();
            const csv = convertToCSV(data);
            downloadCSV(csv, 'instalaciones_soportes.csv');
        }

        // Utilidades
        function getStatusText(status) {
            const statusTexts = {
                'pending': 'Pendiente',
                'planned': 'Planificado',
                'in_progress': 'En Progreso',
                'installed': 'Instalado'
            };
            return statusTexts[status] || status;
        }

        function getStatusIcon(status) {
            const statusIcons = {
                'pending': '‚è≥',
                'planned': 'üìÖ',
                'in_progress': 'üîÑ',
                'installed': '‚úÖ'
            };
            return statusIcons[status] || '‚ùì';
        }

        function isOverdue(plannedDate, status) {
            if (!plannedDate || status === 'installed') return false;
            const planned = new Date(plannedDate);
            const today = new Date();
            return planned < today;
        }

        function formatDateForInput(dateString) {
            const date = new Date(dateString);
            return date.toISOString().split('T')[0];
        }

        function convertToCSV(data) {
            if (!data || data.length === 0) return '';
            
            const headers = Object.keys(data[0]);
            const csvContent = [
                headers.join(','),
                ...data.map(row => headers.map(header => {
                    const value = row[header];
                    return typeof value === 'string' ? `"${value.replace(/"/g, '""')}"` : value;
                }).join(','))
            ].join('\n');
            
            return csvContent;
        }

        function downloadCSV(csv, filename) {
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Crear tarjeta de isom√©trico
        function createIsometricCard(isometric) {
            const sheetLinks = isometric.sheets.map(sheet => 
                `<a href="ISOMETRICOS/${sheet.filename}" target="_blank" class="isometric-file">
                    Hoja ${sheet.sheet_number} (${sheet.revision})
                </a>`
            ).join('');
            
            // Buscar versiones prefabricadas disponibles
            const prefabricatedSheets = [];
            isometric.sheets.forEach(sheet => {
                if (prefabricatedMapping[sheet.filename]) {
                    prefabricatedSheets.push({
                        ...sheet,
                        prefab_path: prefabricatedMapping[sheet.filename].prefab_path,
                        prefab_file: prefabricatedMapping[sheet.filename].prefab_file
                    });
                }
            });
            
            const prefabLinks = prefabricatedSheets.map(sheet => 
                `<a href="${sheet.prefab_path}" target="_blank" class="isometric-file prefab-file">
                    üè≠ Prefab ${sheet.sheet_number} (${sheet.revision})
                </a>`
            ).join('');
            
            const hasPrefab = prefabricatedSheets.length > 0;
            const prefabIndicator = hasPrefab ? ' <span class="prefab-indicator">üè≠</span>' : '';
            
            return `
                <div class="result-card">
                    <h3>üìê L√≠nea ${isometric.line_code}${prefabIndicator}</h3>
                    <div class="info">
                        <div><strong>Fluido:</strong> ${isometric.fluid}</div>
                        <div><strong>Total Hojas:</strong> ${isometric.sheets.length}</div>
                        <div><strong>Tipos:</strong> ${[...new Set(isometric.sheets.map(s => s.type))].join(', ')}</div>
                        <div><strong>Revisiones:</strong> ${[...new Set(isometric.sheets.map(s => s.revision))].join(', ')}</div>
                        ${hasPrefab ? `<div><strong>Prefabricadas:</strong> ${prefabricatedSheets.length}</div>` : ''}
                    </div>
                    <div class="isometric-section">
                        <h4>üìã Hojas del Isom√©trico:</h4>
                        <div class="isometric-files">${sheetLinks}</div>
                    </div>
                    ${hasPrefab ? `
                    <div class="isometric-section">
                        <h4>üè≠ Versiones Prefabricadas:</h4>
                        <div class="isometric-files">${prefabLinks}</div>
                    </div>
                    ` : ''}
                </div>
            `;
        }

        // Crear tarjeta de relaci√≥n
        function createRelationCard(key, relations) {
            const firstRelation = relations[0];
            const isometricFiles = firstRelation.isometric_files.map(file => 
                `<a href="ISOMETRICOS/${file}" target="_blank" class="isometric-file">
                    ${file.split('_')[0]}
                </a>`
            ).join('');
            
            return `
                <div class="result-card">
                    <h3>üîó Soporte ${firstRelation.support_number} - ${firstRelation.support_type}</h3>
                    <div class="info">
                        <div><strong>L√≠nea:</strong> ${firstRelation.line_code}</div>
                        <div><strong>Fluido:</strong> ${firstRelation.fluid}</div>
                        <div><strong>Hoja ISO:</strong> ${firstRelation.iso_sheet}</div>
                        <div><strong>Archivos:</strong> ${firstRelation.isometric_files.length}</div>
        </div>
                    <div class="isometric-section">
                        <h4>üìê Isom√©tricos Relacionados:</h4>
                        <div class="isometric-files">${isometricFiles}</div>
    </div>
                </div>
            `;
        }

        // Mostrar loading
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }

        // Mostrar error
        function showError(message) {
            const container = document.querySelector('.container');
            container.innerHTML += `<div class="error">${message}</div>`;
        }
    </script>
</body>
</html> 
 