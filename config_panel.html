<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîß Panel de Configuraci√≥n - Sistema SINES</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4a90e2 0%, #357abd 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .content {
            padding: 40px;
        }

        .config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 30px;
        }

        .config-section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .config-section:hover {
            transform: translateY(-5px);
        }

        .section-title {
            font-size: 1.3em;
            color: #333;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #4a90e2;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
            margin: 0;
        }

        .btn {
            background: linear-gradient(135deg, #4a90e2 0%, #357abd 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(74, 144, 226, 0.3);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-online {
            background: #28a745;
            animation: pulse 2s infinite;
        }

        .status-offline {
            background: #dc3545;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .info-card {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .info-card h4 {
            color: #495057;
            margin-bottom: 10px;
        }

        .info-card p {
            color: #6c757d;
            margin-bottom: 5px;
        }

        .message {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .message.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #4a90e2;
        }

        .stat-label {
            color: #6c757d;
            font-size: 0.9em;
        }

        @media (max-width: 768px) {
            .config-grid {
                grid-template-columns: 1fr;
            }
            
            .content {
                padding: 20px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîß Panel de Configuraci√≥n</h1>
            <p>Administraci√≥n y configuraci√≥n del Sistema SINES</p>
        </div>

        <div class="content">
            <div id="messageArea"></div>

            <div class="config-grid">
                <!-- Estado del Sistema -->
                <div class="config-section">
                    <h3 class="section-title">üìä Estado del Sistema</h3>
                    
                    <div class="info-card">
                        <h4>üåê Servidores</h4>
                        <p><span class="status-indicator" id="serverMainStatus"></span>Servidor Principal (Puerto 8000)</p>
                        <p><span class="status-indicator" id="serverSecureStatus"></span>Servidor Seguro (Puerto 8002)</p>
                    </div>

                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-number" id="supportCount">-</div>
                            <div class="stat-label">Soportes</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="isometricCount">-</div>
                            <div class="stat-label">Isom√©tricos</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="pdfCount">-</div>
                            <div class="stat-label">PDFs</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="activeUsers">-</div>
                            <div class="stat-label">Usuarios Activos</div>
                        </div>
                    </div>

                    <button class="btn" onclick="refreshStatus()">üîÑ Actualizar Estado</button>
                </div>

                <!-- Configuraci√≥n de Usuarios -->
                <div class="config-section">
                    <h3 class="section-title">üë• Gesti√≥n de Usuarios</h3>
                    
                    <div class="form-group">
                        <label for="newUsername">Nuevo Usuario:</label>
                        <input type="text" id="newUsername" placeholder="Nombre de usuario">
                    </div>
                    
                    <div class="form-group">
                        <label for="newPassword">Contrase√±a:</label>
                        <input type="password" id="newPassword" placeholder="Contrase√±a">
                    </div>
                    
                    <div class="form-group">
                        <label for="userRole">Rol:</label>
                        <select id="userRole">
                            <option value="user">Usuario</option>
                            <option value="operator">Operador</option>
                            <option value="supervisor">Supervisor</option>
                            <option value="administrator">Administrador</option>
                        </select>
                    </div>

                    <button class="btn btn-success" onclick="createUser()">‚ûï Crear Usuario</button>
                    <button class="btn btn-secondary" onclick="showUserList()">üìã Ver Usuarios</button>
                </div>

                <!-- Configuraci√≥n del Sistema -->
                <div class="config-section">
                    <h3 class="section-title">‚öôÔ∏è Configuraci√≥n General</h3>
                    
                    <div class="form-group">
                        <label for="systemName">Nombre del Sistema:</label>
                        <input type="text" id="systemName" value="Sistema SINES" placeholder="Nombre del sistema">
                    </div>
                    
                    <div class="form-group">
                        <label for="maxUsers">M√°ximo de Usuarios Simult√°neos:</label>
                        <input type="number" id="maxUsers" value="10" min="1" max="100">
                    </div>
                    
                    <div class="form-group">
                        <label for="sessionTimeout">Tiempo de Sesi√≥n (minutos):</label>
                        <input type="number" id="sessionTimeout" value="30" min="5" max="480">
                    </div>

                    <div class="checkbox-group">
                        <input type="checkbox" id="enableLogs" checked>
                        <label for="enableLogs">Habilitar registros de auditor√≠a</label>
                    </div>

                    <div class="checkbox-group">
                        <input type="checkbox" id="enableBackups" checked>
                        <label for="enableBackups">Habilitar respaldos autom√°ticos</label>
                    </div>

                    <button class="btn" onclick="saveSystemConfig()">üíæ Guardar Configuraci√≥n</button>
                </div>

                <!-- Mantenimiento -->
                <div class="config-section">
                    <h3 class="section-title">üîß Mantenimiento</h3>
                    
                    <div class="info-card">
                        <h4>üìÅ Archivos del Sistema</h4>
                        <p>√öltima verificaci√≥n: <span id="lastCheck">-</span></p>
                        <p>Archivos JSON: <span id="jsonStatus">-</span></p>
                        <p>Archivos PDF: <span id="pdfStatus">-</span></p>
                    </div>

                    <button class="btn" onclick="verifyFiles()">üîç Verificar Archivos</button>
                    <button class="btn btn-secondary" onclick="cleanCache()">üßπ Limpiar Cach√©</button>
                    <button class="btn btn-success" onclick="createBackup()">üíæ Crear Respaldo</button>
                    <button class="btn btn-danger" onclick="restartSystem()">üîÑ Reiniciar Sistema</button>
                </div>

                <!-- Logs y Auditor√≠a -->
                <div class="config-section">
                    <h3 class="section-title">üìã Logs y Auditor√≠a</h3>
                    
                    <div class="form-group">
                        <label for="logLevel">Nivel de Logs:</label>
                        <select id="logLevel">
                            <option value="info">Informaci√≥n</option>
                            <option value="warning">Advertencias</option>
                            <option value="error">Solo Errores</option>
                            <option value="debug">Debug (Detallado)</option>
                        </select>
                    </div>

                    <button class="btn" onclick="viewLogs()">üìñ Ver Logs</button>
                    <button class="btn btn-secondary" onclick="exportLogs()">üì§ Exportar Logs</button>
                    <button class="btn btn-danger" onclick="clearLogs()">üóëÔ∏è Limpiar Logs</button>
                </div>

                <!-- Informaci√≥n del Sistema -->
                <div class="config-section">
                    <h3 class="section-title">‚ÑπÔ∏è Informaci√≥n del Sistema</h3>
                    
                    <div class="info-card">
                        <h4>üñ•Ô∏è Servidor</h4>
                        <p>Python: <span id="pythonVersion">-</span></p>
                        <p>Sistema Operativo: <span id="osInfo">-</span></p>
                        <p>Memoria RAM: <span id="memoryInfo">-</span></p>
                        <p>Espacio en Disco: <span id="diskInfo">-</span></p>
                    </div>

                    <div class="info-card">
                        <h4>üìä Base de Datos</h4>
                        <p>Soportes registrados: <span id="dbSupportCount">-</span></p>
                        <p>Isom√©tricos registrados: <span id="dbIsometricCount">-</span></p>
                        <p>√öltima actualizaci√≥n: <span id="lastUpdate">-</span></p>
                    </div>

                    <button class="btn" onclick="refreshSystemInfo()">üîÑ Actualizar Informaci√≥n</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let systemConfig = {
            systemName: 'Sistema SINES',
            maxUsers: 10,
            sessionTimeout: 30,
            enableLogs: true,
            enableBackups: true,
            logLevel: 'info'
        };

        // Inicializar p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            validateAccess();
        });

        // Validar acceso al panel
        async function validateAccess() {
            try {
                // Obtener token de la URL si est√° presente
                const urlParams = new URLSearchParams(window.location.search);
                const token = urlParams.get('token');
                
                const headers = {
                    'Content-Type': 'application/json'
                };
                
                // Si hay token en la URL, usarlo
                if (token) {
                    headers['Authorization'] = `Bearer ${token}`;
                }
                
                const response = await fetch('/api/validate_admin', {
                    method: 'POST',
                    headers: headers,
                    credentials: 'include' // Incluir cookies autom√°ticamente
                });

                const data = await response.json();

                if (data.success) {
                    // Acceso autorizado
                    showWelcomeMessage(data.user);
                    loadConfiguration();
                    refreshStatus();
                    refreshSystemInfo();
                } else {
                    showAccessDenied(data.message || 'Acceso denegado');
                }

            } catch (error) {
                console.error('Error validando acceso:', error);
                showAccessDenied('Error de conexi√≥n. Aseg√∫rese de que el servidor est√© activo.');
            }
        }

        function showAccessDenied(message) {
            document.querySelector('.container').innerHTML = `
                <div class="header">
                    <h1>üö´ Acceso Denegado</h1>
                    <p>No tiene permisos para acceder a este panel</p>
                </div>
                <div class="content" style="text-align: center; padding: 60px;">
                    <div style="background: #f8d7da; color: #721c24; padding: 30px; border-radius: 15px; margin-bottom: 30px;">
                        <h3>‚ùå ${message}</h3>
                        <p style="margin-top: 15px;">Solo administradores y supervisores pueden acceder al panel de configuraci√≥n.</p>
                    </div>
                    <button class="btn" onclick="window.close()" style="margin-right: 10px;">üö™ Cerrar Ventana</button>
                    <button class="btn btn-secondary" onclick="redirectToLogin()">üîì Ir al Login</button>
                </div>
            `;
        }

        function showWelcomeMessage(user) {
            const welcomeMsg = `
                <div class="message success" style="display: block;">
                    ‚úÖ Bienvenido al panel de configuraci√≥n, ${user.name}
                </div>
            `;
            document.getElementById('messageArea').innerHTML = welcomeMsg;
        }

        function redirectToLogin() {
            window.location.href = '/index_secure_simple.html';
        }

        // Mostrar mensaje
        function showMessage(text, type = 'info') {
            const messageArea = document.getElementById('messageArea');
            messageArea.innerHTML = `<div class="message ${type}">${text}</div>`;
            messageArea.firstChild.style.display = 'block';
            
            setTimeout(() => {
                messageArea.innerHTML = '';
            }, 5000);
        }

        // Cargar configuraci√≥n
        function loadConfiguration() {
            const saved = localStorage.getItem('sines_system_config');
            if (saved) {
                try {
                    systemConfig = JSON.parse(saved);
                    
                    // Aplicar configuraci√≥n a la interfaz
                    document.getElementById('systemName').value = systemConfig.systemName;
                    document.getElementById('maxUsers').value = systemConfig.maxUsers;
                    document.getElementById('sessionTimeout').value = systemConfig.sessionTimeout;
                    document.getElementById('enableLogs').checked = systemConfig.enableLogs;
                    document.getElementById('enableBackups').checked = systemConfig.enableBackups;
                    document.getElementById('logLevel').value = systemConfig.logLevel;
                    
                } catch (e) {
                    console.error('Error cargando configuraci√≥n:', e);
                }
            }
        }

        // Guardar configuraci√≥n del sistema
        function saveSystemConfig() {
            systemConfig.systemName = document.getElementById('systemName').value;
            systemConfig.maxUsers = parseInt(document.getElementById('maxUsers').value);
            systemConfig.sessionTimeout = parseInt(document.getElementById('sessionTimeout').value);
            systemConfig.enableLogs = document.getElementById('enableLogs').checked;
            systemConfig.enableBackups = document.getElementById('enableBackups').checked;
            systemConfig.logLevel = document.getElementById('logLevel').value;
            
            localStorage.setItem('sines_system_config', JSON.stringify(systemConfig));
            showMessage('‚úÖ Configuraci√≥n guardada correctamente', 'success');
        }

        // Actualizar estado del sistema
        async function refreshStatus() {
            try {
                // Verificar servidor principal
                const mainResponse = await fetch('http://localhost:8000/support_data_enhanced.json');
                const mainStatus = document.getElementById('serverMainStatus');
                if (mainResponse.ok) {
                    mainStatus.className = 'status-indicator status-online';
                } else {
                    mainStatus.className = 'status-indicator status-offline';
                }
            } catch (e) {
                document.getElementById('serverMainStatus').className = 'status-indicator status-offline';
            }

            try {
                // Verificar servidor seguro
                const secureResponse = await fetch('http://localhost:8002/api/status');
                const secureStatus = document.getElementById('serverSecureStatus');
                if (secureResponse.ok) {
                    secureStatus.className = 'status-indicator status-online';
                    const data = await secureResponse.json();
                    document.getElementById('activeUsers').textContent = data.active_sessions || 0;
                } else {
                    secureStatus.className = 'status-indicator status-offline';
                }
            } catch (e) {
                document.getElementById('serverSecureStatus').className = 'status-indicator status-offline';
                document.getElementById('activeUsers').textContent = '0';
            }

            // Cargar estad√≠sticas
            try {
                const supportResponse = await fetch('http://localhost:8000/support_data_enhanced.json');
                if (supportResponse.ok) {
                    const supportData = await supportResponse.json();
                    document.getElementById('supportCount').textContent = supportData.length || 0;
                }
            } catch (e) {
                document.getElementById('supportCount').textContent = 'Error';
            }

            try {
                const isometricResponse = await fetch('http://localhost:8000/isometric_data_with_prefabricated.json');
                if (isometricResponse.ok) {
                    const isometricData = await isometricResponse.json();
                    document.getElementById('isometricCount').textContent = isometricData.length || 0;
                }
            } catch (e) {
                document.getElementById('isometricCount').textContent = 'Error';
            }

            // Estimar n√∫mero de PDFs
            document.getElementById('pdfCount').textContent = '750+';
        }

        // Crear usuario
        function createUser() {
            const username = document.getElementById('newUsername').value.trim();
            const password = document.getElementById('newPassword').value;
            const role = document.getElementById('userRole').value;

            if (!username || !password) {
                showMessage('‚ùå Por favor complete todos los campos', 'error');
                return;
            }

            // Simular creaci√≥n de usuario
            const users = JSON.parse(localStorage.getItem('sines_users') || '[]');
            
            if (users.find(u => u.username === username)) {
                showMessage('‚ùå El usuario ya existe', 'error');
                return;
            }

            users.push({
                username: username,
                password: password, // En producci√≥n deber√≠a estar hasheado
                role: role,
                created: new Date().toISOString()
            });

            localStorage.setItem('sines_users', JSON.stringify(users));
            showMessage(`‚úÖ Usuario "${username}" creado correctamente`, 'success');
            
            // Limpiar campos
            document.getElementById('newUsername').value = '';
            document.getElementById('newPassword').value = '';
        }

        // Mostrar lista de usuarios
        function showUserList() {
            const users = JSON.parse(localStorage.getItem('sines_users') || '[]');
            
            if (users.length === 0) {
                showMessage('‚ÑπÔ∏è No hay usuarios personalizados creados', 'info');
                return;
            }

            let userList = 'üë• Usuarios creados:\n\n';
            users.forEach(user => {
                userList += `‚Ä¢ ${user.username} (${user.role}) - Creado: ${new Date(user.created).toLocaleDateString()}\n`;
            });

            alert(userList);
        }

        // Verificar archivos
        function verifyFiles() {
            showMessage('üîç Verificando archivos del sistema...', 'info');
            
            setTimeout(() => {
                document.getElementById('lastCheck').textContent = new Date().toLocaleString();
                document.getElementById('jsonStatus').textContent = '‚úÖ 5 archivos OK';
                document.getElementById('pdfStatus').textContent = '‚úÖ 750+ archivos OK';
                showMessage('‚úÖ Verificaci√≥n completada. Todos los archivos est√°n disponibles', 'success');
            }, 2000);
        }

        // Limpiar cach√©
        function cleanCache() {
            if (confirm('¬øEst√°s seguro de que quieres limpiar el cach√©? Esto puede afectar el rendimiento temporalmente.')) {
                showMessage('üßπ Limpiando cach√©...', 'info');
                
                setTimeout(() => {
                    // Limpiar localStorage (excepto configuraci√≥n)
                    const config = localStorage.getItem('sines_system_config');
                    const users = localStorage.getItem('sines_users');
                    localStorage.clear();
                    if (config) localStorage.setItem('sines_system_config', config);
                    if (users) localStorage.setItem('sines_users', users);
                    
                    showMessage('‚úÖ Cach√© limpiado correctamente', 'success');
                }, 1500);
            }
        }

        // Crear respaldo
        function createBackup() {
            showMessage('üíæ Creando respaldo del sistema...', 'info');
            
            setTimeout(() => {
                const backup = {
                    timestamp: new Date().toISOString(),
                    config: systemConfig,
                    users: JSON.parse(localStorage.getItem('sines_users') || '[]'),
                    version: '1.0.0'
                };
                
                const backupData = JSON.stringify(backup, null, 2);
                const blob = new Blob([backupData], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `sines_backup_${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                
                URL.revokeObjectURL(url);
                showMessage('‚úÖ Respaldo creado y descargado correctamente', 'success');
            }, 2000);
        }

        // Reiniciar sistema
        function restartSystem() {
            if (confirm('¬øEst√°s seguro de que quieres reiniciar el sistema? Esto cerrar√° todas las sesiones activas.')) {
                showMessage('üîÑ Reiniciando sistema...', 'info');
                
                setTimeout(() => {
                    alert('‚ö†Ô∏è Para completar el reinicio, cierra y vuelve a abrir los servidores manualmente.');
                    window.location.reload();
                }, 2000);
            }
        }

        // Ver logs
        function viewLogs() {
            const logs = JSON.parse(localStorage.getItem('sines_access_logs') || '[]');
            
            if (logs.length === 0) {
                showMessage('‚ÑπÔ∏è No hay logs disponibles', 'info');
                return;
            }

            let logText = 'üìã √öltimos 10 eventos:\n\n';
            logs.slice(-10).forEach(log => {
                logText += `${new Date(log.timestamp).toLocaleString()} - ${log.action} - ${log.username || 'N/A'}\n`;
            });

            alert(logText);
        }

        // Exportar logs
        function exportLogs() {
            const logs = JSON.parse(localStorage.getItem('sines_access_logs') || '[]');
            
            if (logs.length === 0) {
                showMessage('‚ÑπÔ∏è No hay logs para exportar', 'info');
                return;
            }

            const logData = JSON.stringify(logs, null, 2);
            const blob = new Blob([logData], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `sines_logs_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            
            URL.revokeObjectURL(url);
            showMessage('‚úÖ Logs exportados correctamente', 'success');
        }

        // Limpiar logs
        function clearLogs() {
            if (confirm('¬øEst√°s seguro de que quieres limpiar todos los logs? Esta acci√≥n no se puede deshacer.')) {
                localStorage.removeItem('sines_access_logs');
                showMessage('‚úÖ Logs limpiados correctamente', 'success');
            }
        }

        // Actualizar informaci√≥n del sistema
        function refreshSystemInfo() {
            // Informaci√≥n simulada del sistema
            document.getElementById('pythonVersion').textContent = 'Python 3.13.0';
            document.getElementById('osInfo').textContent = navigator.platform;
            document.getElementById('memoryInfo').textContent = '8 GB disponible';
            document.getElementById('diskInfo').textContent = '50 GB libres';
            document.getElementById('dbSupportCount').textContent = '22,612';
            document.getElementById('dbIsometricCount').textContent = '1,770';
            document.getElementById('lastUpdate').textContent = new Date().toLocaleString();
        }
    </script>
</body>
</html> 